<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYNERGIA v3.0</title>
    
    <!-- CSP pour Google OAuth -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com https://www.googletagmanager.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        connect-src 'self' https://*.googleapis.com https://*.google.com https://*.firebaseapp.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firebase.googleapis.com https://content.googleapis.com https://firebaseinstallations.googleapis.com https://firebaseremoteconfig.googleapis.com https://firebaselogging-pa.googleapis.com https://region1.google-analytics.com wss://*.firebaseio.com wss://*.firebaseapp.com;
        frame-src 'self' https://accounts.google.com https://*.firebaseapp.com;
        img-src 'self' data: https: *.googleusercontent.com *.googleapis.com;
    ">
    
    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23e94560'/%3E%3Ctext x='50' y='60' font-family='Arial' font-size='40' fill='white' text-anchor='middle'%3ES%3C/text%3E%3C/svg%3E">
    <meta name="theme-color" content="#1a1a2e">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- =========================== -->
    <!-- CSS VARIABLES & BASE STYLES -->
    <!-- =========================== -->
    <style>
        /* Variables CSS */
        :root {
            --primary-color: #1a1a2e;
            --secondary-color: #16213e;
            --accent-color: #e94560;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            
            --text-light: #ffffff;
            --text-secondary: #b8b9ba;
            --text-muted: #8a8b8c;
            
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-bg-strong: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            
            --border-radius: 0.5rem;
            --border-radius-lg: 1rem;
            --transition: 300ms ease-in-out;
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-light);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Component styles */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 24px;
            margin: 20px 0;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all var(--transition);
            text-decoration: none;
            display: inline-block;
            text-align: center;
            min-width: 120px;
        }
        
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: var(--accent-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-warning { background: var(--warning-color); color: #000; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-secondary { 
            background: var(--glass-bg); 
            color: var(--text-light); 
            border: 1px solid var(--glass-border); 
        }
        .btn-sm { padding: 8px 16px; font-size: 14px; min-width: auto; }
        .btn-lg { padding: 16px 32px; font-size: 18px; min-width: 180px; }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status-online { background: var(--success-color); color: white; }
        .status-offline { background: var(--text-muted); color: white; }
        .status-admin { background: var(--danger-color); color: white; }
        .status-manager { background: var(--warning-color); color: #000; }
        .status-employee { background: var(--info-color); color: white; }
        .status-present { background: var(--success-color); color: white; }
        .status-absent { background: var(--danger-color); color: white; }
        .status-late { background: var(--warning-color); color: #000; }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--glass-bg-strong);
            border-radius: var(--border-radius);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            gap: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 12px 20px;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition);
            text-decoration: none;
            font-weight: 500;
        }
        
        .nav-tab:hover {
            background: var(--glass-bg);
            color: var(--text-light);
        }
        
        .nav-tab.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        /* Table styles */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            background: var(--glass-bg);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            background: transparent;
        }
        
        .table th,
        .table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .table th {
            background: var(--glass-bg-strong);
            font-weight: 600;
            color: var(--text-light);
            font-size: 14px;
        }
        
        .table td {
            color: var(--text-light);
        }
        
        .table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* Form styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-light);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            background: var(--glass-bg);
            color: var(--text-light);
            font-size: 16px;
            transition: all var(--transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.1);
        }
        
        .form-control::placeholder {
            color: var(--text-muted);
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--secondary-color);
            margin: 20px;
            padding: 30px;
            border-radius: var(--border-radius-lg);
            max-width: 500px;
            width: 100%;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-light);
        }
        
        .close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-muted);
            line-height: 1;
        }
        
        .close:hover {
            color: var(--text-light);
        }
        
        /* Grid layout */
        .grid {
            display: grid;
            gap: 20px;
        }
        
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        
        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        
        /* Stats cards */
        .stats-card {
            background: var(--glass-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid var(--glass-border);
            text-align: center;
        }
        
        .stats-number {
            font-size: 32px;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 8px;
        }
        
        .stats-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Badging specific styles */
        .clock-widget {
            background: var(--glass-bg-strong);
            padding: 40px;
            border-radius: var(--border-radius-lg);
            text-align: center;
            border: 1px solid var(--glass-border);
        }
        
        .current-time {
            font-size: 48px;
            font-weight: bold;
            color: var(--text-light);
            margin-bottom: 16px;
            font-family: 'Courier New', monospace;
        }
        
        .current-date {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }
        
        .badge-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .badge-status {
            background: var(--glass-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid var(--glass-border);
            margin-bottom: 20px;
        }
        
        .time-display {
            font-size: 24px;
            font-weight: bold;
            color: var(--text-light);
            font-family: 'Courier New', monospace;
        }
        
        .time-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .hours-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--glass-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--glass-border);
            margin-bottom: 20px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 16px; }
            .header { flex-direction: column; align-items: stretch; }
            .nav-tabs { overflow-x: auto; padding-bottom: 8px; }
            .nav-tab { white-space: nowrap; }
            .table-container { font-size: 14px; }
            .modal-content { margin: 10px; padding: 20px; }
            .current-time { font-size: 36px; }
            .badge-buttons { flex-direction: column; align-items: center; }
            .btn-lg { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Chargement de SYNERGIA v3.0...</p>
        </div>
    </div>

    <!-- Modal pour l'équipe -->
    <div id="teamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Ajouter un membre</h2>
                <button class="close" onclick="closeTeamModal()">&times;</button>
            </div>
            <form id="teamForm">
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" id="memberEmail" class="form-control" placeholder="exemple@entreprise.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Nom complet</label>
                    <input type="text" id="memberName" class="form-control" placeholder="Prénom Nom">
                </div>
                <div class="form-group">
                    <label class="form-label">Rôle</label>
                    <select id="memberRole" class="form-control">
                        <option value="employee">Employé</option>
                        <option value="manager">Manager</option>
                        <option value="admin">Administrateur</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Département</label>
                    <input type="text" id="memberDepartment" class="form-control" placeholder="IT, RH, Commercial...">
                </div>
                <div class="form-group">
                    <label class="form-label">Poste</label>
                    <input type="text" id="memberPosition" class="form-control" placeholder="Développeur, Manager...">
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" onclick="closeTeamModal()" class="btn btn-secondary">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal pour ajouter une note de pointage -->
    <div id="badgeNoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ajouter une note</h2>
                <button class="close" onclick="closeBadgeNoteModal()">&times;</button>
            </div>
            <form id="badgeNoteForm">
                <div class="form-group">
                    <label class="form-label">Note (optionnelle)</label>
                    <textarea id="badgeNote" class="form-control" rows="3" placeholder="Raison du retard, projet spécial, etc."></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" onclick="closeBadgeNoteModal()" class="btn btn-secondary">Annuler</button>
                    <button type="submit" class="btn btn-primary">Confirmer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========================= -->
    <!-- CONFIGURATION & FIREBASE  -->
    <!-- ========================= -->
    <script>
        // Configuration Firebase
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyD7uBuAQaOhZ02owkZEuMKC5Vji6PrB2f8",
            authDomain: "synergia-app-f27e7.firebaseapp.com",
            projectId: "synergia-app-f27e7",
            storageBucket: "synergia-app-f27e7.firebasestorage.app",
            messagingSenderId: "201912738922",
            appId: "1:201912738922:web:2fcc1e49293bb632899613",
            measurementId: "G-EGJ79SCMWX"
        };

        window.FIREBASE_CONFIG = FIREBASE_CONFIG;
    </script>

    <!-- ================== -->
    <!-- FIREBASE SERVICE   -->
    <!-- ================== -->
    <script>
        class FirebaseService {
            constructor() {
                this.app = null;
                this.auth = null;
                this.firestore = null;
                this.isInitialized = false;
            }

            async initialize() {
                try {
                    console.log('🔥 Initialisation Firebase...');
                    await this.waitForFirebase();
                    
                    this.app = firebase.initializeApp(FIREBASE_CONFIG);
                    this.auth = firebase.auth();
                    this.firestore = firebase.firestore();
                    
                    this.isInitialized = true;
                    console.log('✅ Firebase initialisé');
                    
                    window.dispatchEvent(new CustomEvent('firebase:initialized'));
                } catch (error) {
                    console.error('❌ Erreur Firebase:', error);
                    throw error;
                }
            }

            waitForFirebase() {
                return new Promise((resolve, reject) => {
                    let attempts = 0;
                    const check = () => {
                        if (typeof firebase !== 'undefined') {
                            resolve();
                        } else if (attempts < 50) {
                            attempts++;
                            setTimeout(check, 100);
                        } else {
                            reject(new Error('Firebase non disponible'));
                        }
                    };
                    check();
                });
            }

            getAuth() { return this.auth; }
            getFirestore() { return this.firestore; }
        }

        window.firebaseService = new FirebaseService();
    </script>

    <!-- ================ -->
    <!-- AUTH MANAGER     -->
    <!-- ================ -->
    <script>
        class AuthManager {
            constructor() {
                this.currentUser = null;
                this.userProfile = null;
                this.isInitialized = false;
                this.init();
            }

            async init() {
                try {
                    console.log('🔐 Initialisation AuthManager...');
                    await firebaseService.initialize();
                    this.auth = firebaseService.getAuth();
                    this.firestore = firebaseService.getFirestore();
                    
                    this.auth.onAuthStateChanged((user) => {
                        this.handleAuthStateChange(user);
                    });
                    
                    this.isInitialized = true;
                    console.log('✅ AuthManager initialisé');
                } catch (error) {
                    console.error('❌ Erreur AuthManager:', error);
                }
            }

            async handleAuthStateChange(user) {
                console.log('👤 Changement état auth:', user ? user.email : 'Déconnecté');
                this.currentUser = user;
                
                if (user) {
                    await this.loadUserProfile(user.uid);
                    this.emit('user:login', { user, profile: this.userProfile });
                } else {
                    this.userProfile = null;
                    this.emit('user:logout');
                }
                
                this.emit('auth:stateChanged', {
                    user: this.currentUser,
                    profile: this.userProfile,
                    isAuthenticated: !!user
                });
                
                if (window.router) {
                    window.router.render();
                }
            }

            async signInWithGoogle() {
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.addScope('email');
                    provider.addScope('profile');
                    provider.setCustomParameters({ prompt: 'select_account' });
                    
                    const result = await this.auth.signInWithPopup(provider);
                    await this.createOrUpdateUserProfile(result.user);
                    
                    return { success: true, user: result.user };
                } catch (error) {
                    console.error('Erreur connexion Google:', error);
                    throw error;
                }
            }

            async signOut() {
                try {
                    await this.auth.signOut();
                    return { success: true };
                } catch (error) {
                    console.error('Erreur déconnexion:', error);
                    throw error;
                }
            }

            async loadUserProfile(uid) {
                try {
                    const doc = await this.firestore.collection('users').doc(uid).get();
                    if (doc.exists) {
                        this.userProfile = { id: uid, ...doc.data() };
                    } else {
                        await this.createUserProfile(this.currentUser);
                    }
                } catch (error) {
                    console.error('Erreur chargement profil:', error);
                }
            }

            async createOrUpdateUserProfile(user) {
                const userRef = this.firestore.collection('users').doc(user.uid);
                const userData = {
                    email: user.email,
                    displayName: user.displayName || '',
                    photoURL: user.photoURL || '',
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    await userRef.set(userData, { merge: true });
                    await this.loadUserProfile(user.uid);
                } catch (error) {
                    console.error('Erreur mise à jour profil:', error);
                }
            }

            async createUserProfile(user) {
                const userData = {
                    email: user.email,
                    displayName: user.displayName || '',
                    photoURL: user.photoURL || '',
                    role: 'employee',
                    department: '',
                    position: '',
                    xp: 0,
                    level: 1,
                    status: 'active',
                    preferences: { theme: 'dark', notifications: true },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await this.firestore.collection('users').doc(user.uid).set(userData);
                this.userProfile = { id: user.uid, ...userData };
            }

            isAuthenticated() { return !!this.currentUser; }
            getCurrentUser() { return this.currentUser; }
            getUserProfile() { return this.userProfile; }

            emit(eventName, data) {
                window.dispatchEvent(new CustomEvent(eventName, { detail: data }));
            }
        }

        window.authManager = new AuthManager();
    </script>

    <!-- ================ -->
    <!-- TEAM MANAGER     -->
    <!-- ================ -->
    <script>
        class TeamManager {
            constructor() {
                this.firestore = null;
                this.members = [];
                this.isInitialized = false;
                this.init();
            }

            async init() {
                try {
                    await this.waitForFirebase();
                    this.firestore = firebaseService.getFirestore();
                    this.isInitialized = true;
                    console.log('✅ TeamManager initialisé');
                } catch (error) {
                    console.error('❌ Erreur TeamManager:', error);
                }
            }

            async waitForFirebase() {
                return new Promise((resolve) => {
                    const check = () => {
                        if (window.firebaseService && window.firebaseService.isInitialized) {
                            resolve();
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });
            }

            async loadTeamMembers() {
                try {
                    console.log('📄 Chargement des membres...');
                    
                    const snapshot = await this.firestore.collection('users')
                        .orderBy('displayName')
                        .get();
                    
                    this.members = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        createdAt: doc.data().createdAt?.toDate(),
                        updatedAt: doc.data().updatedAt?.toDate(),
                        lastSeen: doc.data().lastSeen?.toDate()
                    }));
                    
                    console.log(`✅ ${this.members.length} membres chargés`);
                    this.emit('team:loaded', this.members);
                    
                    return this.members;
                } catch (error) {
                    console.error('❌ Erreur chargement équipe:', error);
                    throw error;
                }
            }

            async addMember(memberData) {
                try {
                    console.log('➕ Ajout membre:', memberData.email);
                    
                    const existingUser = await this.findMemberByEmail(memberData.email);
                    if (existingUser) {
                        throw new Error('Un utilisateur avec cet email existe déjà');
                    }

                    const newMemberData = {
                        email: memberData.email.toLowerCase().trim(),
                        displayName: memberData.displayName?.trim() || '',
                        role: memberData.role || 'employee',
                        department: memberData.department?.trim() || '',
                        position: memberData.position?.trim() || '',
                        status: 'invited',
                        xp: 0,
                        level: 1,
                        photoURL: '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        invitedBy: authManager.getCurrentUser()?.uid || null,
                        preferences: { theme: 'dark', notifications: true }
                    };

                    const docRef = await this.firestore.collection('users').add(newMemberData);
                    
                    const newMember = { 
                        id: docRef.id, 
                        ...newMemberData,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    };
                    
                    this.members.push(newMember);
                    
                    console.log('✅ Membre ajouté:', newMember.email);
                    this.emit('member:added', newMember);
                    
                    return newMember;
                } catch (error) {
                    console.error('❌ Erreur ajout membre:', error);
                    throw error;
                }
            }

            async updateMember(memberId, updates) {
                try {
                    console.log('🔄 Mise à jour membre:', memberId);
                    
                    const updateData = {
                        ...updates,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await this.firestore.collection('users').doc(memberId).update(updateData);
                    
                    const memberIndex = this.members.findIndex(m => m.id === memberId);
                    if (memberIndex !== -1) {
                        this.members[memberIndex] = { 
                            ...this.members[memberIndex], 
                            ...updates,
                            updatedAt: new Date()
                        };
                        
                        console.log('✅ Membre mis à jour');
                        this.emit('member:updated', this.members[memberIndex]);
                        
                        return this.members[memberIndex];
                    }
                } catch (error) {
                    console.error('❌ Erreur mise à jour membre:', error);
                    throw error;
                }
            }

            async deleteMember(memberId) {
                try {
                    console.log('🗑️ Suppression membre:', memberId);
                    
                    const currentUser = authManager.getCurrentUser();
                    if (currentUser && currentUser.uid === memberId) {
                        throw new Error('Impossible de supprimer votre propre compte');
                    }

                    await this.firestore.collection('users').doc(memberId).delete();
                    
                    const memberIndex = this.members.findIndex(m => m.id === memberId);
                    if (memberIndex !== -1) {
                        const deletedMember = this.members[memberIndex];
                        this.members.splice(memberIndex, 1);
                        
                        console.log('✅ Membre supprimé');
                        this.emit('member:deleted', { id: memberId, member: deletedMember });
                    }
                    
                    return true;
                } catch (error) {
                    console.error('❌ Erreur suppression membre:', error);
                    throw error;
                }
            }

            async findMemberByEmail(email) {
                try {
                    const snapshot = await this.firestore.collection('users')
                        .where('email', '==', email.toLowerCase().trim())
                        .limit(1)
                        .get();
                    
                    if (!snapshot.empty) {
                        const doc = snapshot.docs[0];
                        return { id: doc.id, ...doc.data() };
                    }
                    
                    return null;
                } catch (error) {
                    console.error('❌ Erreur recherche par email:', error);
                    return null;
                }
            }

            getMembers() { return [...this.members]; }

            getTeamStats() {
                const total = this.members.length;
                const active = this.members.filter(m => m.status === 'active').length;
                const invited = this.members.filter(m => m.status === 'invited').length;
                const inactive = this.members.filter(m => m.status === 'inactive').length;
                
                const departments = [...new Set(
                    this.members
                        .map(m => m.department)
                        .filter(d => d && d.trim())
                )];
                
                return { total, active, invited, inactive, departments: departments.length };
            }

            emit(eventName, data) {
                window.dispatchEvent(new CustomEvent(eventName, { detail: data }));
            }
        }

        window.teamManager = new TeamManager();
    </script>

    <!-- =================== -->
    <!-- BADGING MANAGER     -->
    <!-- =================== -->
    <script>
        class BadgingManager {
            constructor() {
                this.firestore = null;
                this.currentTimesheet = null;
                this.timesheets = [];
                this.isInitialized = false;
                this.clockInterval = null;
                this.init();
            }

            async init() {
                try {
                    await this.waitForFirebase();
                    this.firestore = firebaseService.getFirestore();
                    this.isInitialized = true;
                    console.log('✅ BadgingManager initialisé');
                    
                    await this.loadTodaysTimesheet();
                } catch (error) {
                    console.error('❌ Erreur BadgingManager:', error);
                }
            }

            async waitForFirebase() {
                return new Promise((resolve) => {
                    const check = () => {
                        if (window.firebaseService && window.firebaseService.isInitialized) {
                            resolve();
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });
            }

            startClock() {
                this.updateClock();
                this.clockInterval = setInterval(() => {
                    this.updateClock();
                }, 1000);
            }

            stopClock() {
                if (this.clockInterval) {
                    clearInterval(this.clockInterval);
                    this.clockInterval = null;
                }
            }

            updateClock() {
                const now = new Date();
                const timeElement = document.getElementById('currentTime');
                const dateElement = document.getElementById('currentDate');
                
                if (timeElement) {
                    timeElement.textContent = now.toLocaleTimeString('fr-FR');
                }
                
                if (dateElement) {
                    dateElement.textContent = now.toLocaleDateString('fr-FR', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }
            }

            async loadTodaysTimesheet() {
                try {
                    const user = authManager.getCurrentUser();
                    if (!user) return;

                    const today = this.getDateString(new Date());
                    
                    const snapshot = await this.firestore.collection('timesheets')
                        .where('userId', '==', user.uid)
                        .where('date', '==', today)
                        .limit(1)
                        .get();
                    
                    if (!snapshot.empty) {
                        const doc = snapshot.docs[0];
                        this.currentTimesheet = { 
                            id: doc.id, 
                            ...doc.data(),
                            checkIn: doc.data().checkIn?.toDate(),
                            checkOut: doc.data().checkOut?.toDate(),
                            breakStart: doc.data().breakStart?.toDate(),
                            breakEnd: doc.data().breakEnd?.toDate()
                        };
                    } else {
                        this.currentTimesheet = null;
                    }
                    
                    this.emit('timesheet:loaded', this.currentTimesheet);
                    console.log('✅ Feuille de temps du jour chargée');
                } catch (error) {
                    console.error('❌ Erreur chargement timesheet:', error);
                }
            }

            async checkIn(note = '') {
                try {
                    const user = authManager.getCurrentUser();
                    if (!user) throw new Error('Utilisateur non connecté');

                    if (this.currentTimesheet && this.currentTimesheet.checkIn) {
                        throw new Error('Vous avez déjà pointé votre arrivée aujourd\'hui');
                    }

                    const now = new Date();
                    const today = this.getDateString(now);
                    
                    const timesheetData = {
                        userId: user.uid,
                        date: today,
                        checkIn: firebase.firestore.Timestamp.fromDate(now),
                        checkOut: null,
                        breakStart: null,
                        breakEnd: null,
                        totalHours: 0,
                        status: this.calculateStatus(now),
                        notes: note,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    if (this.currentTimesheet) {
                        await this.firestore.collection('timesheets')
                            .doc(this.currentTimesheet.id)
                            .update({
                                checkIn: timesheetData.checkIn,
                                status: timesheetData.status,
                                notes: note,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        
                        this.currentTimesheet.checkIn = now;
                        this.currentTimesheet.status = timesheetData.status;
                        this.currentTimesheet.notes = note;
                    } else {
                        const docRef = await this.firestore.collection('timesheets').add(timesheetData);
                        this.currentTimesheet = {
                            id: docRef.id,
                            ...timesheetData,
                            checkIn: now,
                            createdAt: now,
                            updatedAt: now
                        };
                    }

                    console.log('✅ Pointage d\'arrivée enregistré');
                    this.emit('badge:checkin', this.currentTimesheet);
                    
                    return this.currentTimesheet;
                } catch (error) {
                    console.error('❌ Erreur check-in:', error);
                    throw error;
                }
            }

            async checkOut(note = '') {
                try {
                    const user = authManager.getCurrentUser();
                    if (!user) throw new Error('Utilisateur non connecté');

                    if (!this.currentTimesheet || !this.currentTimesheet.checkIn) {
                        throw new Error('Vous devez d\'abord pointer votre arrivée');
                    }

                    if (this.currentTimesheet.checkOut) {
                        throw new Error('Vous avez déjà pointé votre sortie aujourd\'hui');
                    }

                    const now = new Date();
                    const totalHours = this.calculateTotalHours(this.currentTimesheet.checkIn, now);
                    
                    const updateData = {
                        checkOut: firebase.firestore.Timestamp.fromDate(now),
                        totalHours: totalHours,
                        notes: note || this.currentTimesheet.notes,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await this.firestore.collection('timesheets')
                        .doc(this.currentTimesheet.id)
                        .update(updateData);
                    
                    this.currentTimesheet.checkOut = now;
                    this.currentTimesheet.totalHours = totalHours;
                    this.currentTimesheet.notes = note || this.currentTimesheet.notes;

                    console.log('✅ Pointage de sortie enregistré');
                    this.emit('badge:checkout', this.currentTimesheet);
                    
                    return this.currentTimesheet;
                } catch (error) {
                    console.error('❌ Erreur check-out:', error);
                    throw error;
                }
            }

            async startBreak(note = '') {
                try {
                    if (!this.currentTimesheet || !this.currentTimesheet.checkIn) {
                        throw new Error('Vous devez d\'abord pointer votre arrivée');
                    }

                    if (this.currentTimesheet.breakStart && !this.currentTimesheet.breakEnd) {
                        throw new Error('Vous êtes déjà en pause');
                    }

                    const now = new Date();
                    
                    await this.firestore.collection('timesheets')
                        .doc(this.currentTimesheet.id)
                        .update({
                            breakStart: firebase.firestore.Timestamp.fromDate(now),
                            breakEnd: null,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    
                    this.currentTimesheet.breakStart = now;
                    this.currentTimesheet.breakEnd = null;

                    console.log('✅ Début de pause enregistré');
                    this.emit('badge:breakstart', this.currentTimesheet);
                    
                    return this.currentTimesheet;
                } catch (error) {
                    console.error('❌ Erreur début pause:', error);
                    throw error;
                }
            }

            async endBreak(note = '') {
                try {
                    if (!this.currentTimesheet || !this.currentTimesheet.breakStart) {
                        throw new Error('Vous devez d\'abord commencer une pause');
                    }

                    if (this.currentTimesheet.breakEnd) {
                        throw new Error('Vous avez déjà terminé votre pause');
                    }

                    const now = new Date();
                    
                    await this.firestore.collection('timesheets')
                        .doc(this.currentTimesheet.id)
                        .update({
                            breakEnd: firebase.firestore.Timestamp.fromDate(now),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    
                    this.currentTimesheet.breakEnd = now;

                    console.log('✅ Fin de pause enregistrée');
                    this.emit('badge:breakend', this.currentTimesheet);
                    
                    return this.currentTimesheet;
                } catch (error) {
                    console.error('❌ Erreur fin pause:', error);
                    throw error;
                }
            }

            async loadTimesheets(userId = null, startDate = null, endDate = null) {
                try {
                    const user = authManager.getCurrentUser();
                    const targetUserId = userId || user?.uid;
                    
                    if (!targetUserId) throw new Error('Utilisateur non spécifié');

                    let query = this.firestore.collection('timesheets')
                        .where('userId', '==', targetUserId);

                    if (startDate) {
                        query = query.where('date', '>=', this.getDateString(startDate));
                    }
                    
                    if (endDate) {
                        query = query.where('date', '<=', this.getDateString(endDate));
                    }

                    const snapshot = await query.orderBy('date', 'desc').limit(30).get();
                    
                    this.timesheets = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        checkIn: doc.data().checkIn?.toDate(),
                        checkOut: doc.data().checkOut?.toDate(),
                        breakStart: doc.data().breakStart?.toDate(),
                        breakEnd: doc.data().breakEnd?.toDate(),
                        createdAt: doc.data().createdAt?.toDate(),
                        updatedAt: doc.data().updatedAt?.toDate()
                    }));
                    
                    console.log(`✅ ${this.timesheets.length} feuilles de temps chargées`);
                    this.emit('timesheets:loaded', this.timesheets);
                    
                    return this.timesheets;
                } catch (error) {
                    console.error('❌ Erreur chargement timesheets:', error);
                    throw error;
                }
            }

            calculateStatus(checkInTime) {
                const hour = checkInTime.getHours();
                const minute = checkInTime.getMinutes();
                
                if (hour < 9 || (hour === 9 && minute === 0)) {
                    return 'present';
                } else if (hour === 9 && minute <= 15) {
                    return 'present';
                } else {
                    return 'late';
                }
            }

            calculateTotalHours(checkIn, checkOut) {
                if (!checkIn || !checkOut) return 0;
                
                const diffMs = checkOut.getTime() - checkIn.getTime();
                const diffHours = diffMs / (1000 * 60 * 60);
                
                return Math.round(diffHours * 100) / 100;
            }

            getCurrentStatus() {
                if (!this.currentTimesheet) return 'not-started';
                
                if (this.currentTimesheet.checkOut) return 'finished';
                if (this.currentTimesheet.breakStart && !this.currentTimesheet.breakEnd) return 'on-break';
                if (this.currentTimesheet.checkIn) return 'working';
                
                return 'not-started';
            }

            getTodaysStats() {
                if (!this.currentTimesheet) {
                    return {
                        checkIn: null,
                        checkOut: null,
                        totalHours: 0,
                        status: 'not-started',
                        breakDuration: 0
                    };
                }

                let breakDuration = 0;
                if (this.currentTimesheet.breakStart && this.currentTimesheet.breakEnd) {
                    breakDuration = (this.currentTimesheet.breakEnd.getTime() - this.currentTimesheet.breakStart.getTime()) / (1000 * 60);
                }

                return {
                    checkIn: this.currentTimesheet.checkIn,
                    checkOut: this.currentTimesheet.checkOut,
                    totalHours: this.currentTimesheet.totalHours || 0,
                    status: this.currentTimesheet.status || 'present',
                    breakDuration: Math.round(breakDuration)
                };
            }

            getDateString(date) {
                return date.toISOString().split('T')[0];
            }

            getCurrentTimesheet() { return this.currentTimesheet; }
            getTimesheets() { return [...this.timesheets]; }

            emit(eventName, data) {
                window.dispatchEvent(new CustomEvent(eventName, { detail: data }));
            }
        }

        window.badgingManager = new BadgingManager();
    </script>

    <!-- ============ -->
    <!-- ROUTER       -->
    <!-- ============ -->
    <script>
        class Router {
            constructor() {
                this.currentPath = '/';
                this.init();
            }

            navigate(path) {
                window.location.hash = path;
                this.render();
            }

            render() {
                const hash = window.location.hash.slice(1) || '/';
                const app = document.getElementById('app');
                
                console.log('📄 Rendu page:', hash);
                
                if (!window.authManager || !window.authManager.isInitialized) {
                    console.log('⏳ Attente AuthManager...');
                    app.innerHTML = `
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <p>Initialisation de l'authentification...</p>
                        </div>
                    `;
                    return;
                }
                
                const isAuthenticated = authManager.isAuthenticated();
                console.log('🔐 Utilisateur authentifié:', isAuthenticated);
                
                switch(hash) {
                    case '/':
                    case '/dashboard':
                        if (isAuthenticated) {
                            app.innerHTML = this.renderDashboard();
                        } else {
                            this.navigate('/login');
                        }
                        break;
                    case '/login':
                        app.innerHTML = this.renderLogin();
                        break;
                    case '/profile':
                        if (isAuthenticated) {
                            app.innerHTML = this.renderProfile();
                        } else {
                            this.navigate('/login');
                        }
                        break;
                    case '/team':
                        if (isAuthenticated) {
                            app.innerHTML = this.renderTeam();
                            this.loadTeamData();
                        } else {
                            this.navigate('/login');
                        }
                        break;
                    case '/badging':
                        if (isAuthenticated) {
                            app.innerHTML = this.renderBadging();
                            this.loadBadgingData();
                        } else {
                            this.navigate('/login');
                        }
                        break;
                    default:
                        app.innerHTML = this.render404();
                }
            }

            async loadTeamData() {
                try {
                    await teamManager.loadTeamMembers();
                    this.updateTeamView();
                } catch (error) {
                    console.error('Erreur chargement équipe:', error);
                }
            }

            async loadBadgingData() {
                try {
                    while (!window.badgingManager || !window.badgingManager.isInitialized) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    await badgingManager.loadTodaysTimesheet();
                    await badgingManager.loadTimesheets();
                    this.updateBadgingView();
                    
                    // Démarrer l'horloge
                    badgingManager.startClock();
                } catch (error) {
                    console.error('Erreur chargement badging:', error);
                }
            }

            updateBadgingView() {
                const stats = badgingManager.getTodaysStats();
                this.updateBadgingStats(stats);
                this.updateBadgingButtons();
                this.updateTimesheetsTable();
            }

            updateBadgingStats(stats) {
                const elements = {
                    checkinTime: document.getElementById('checkinTime'),
                    checkoutTime: document.getElementById('checkoutTime'),
                    totalHours: document.getElementById('totalHours'),
                    breakDuration: document.getElementById('breakDuration')
                };

                if (elements.checkinTime) {
                    elements.checkinTime.textContent = stats.checkIn ? 
                        stats.checkIn.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '--:--';
                }
                
                if (elements.checkoutTime) {
                    elements.checkoutTime.textContent = stats.checkOut ? 
                        stats.checkOut.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '--:--';
                }
                
                if (elements.totalHours) {
                    elements.totalHours.textContent = stats.totalHours ? 
                        `${stats.totalHours}h` : '0h';
                }
                
                if (elements.breakDuration) {
                    elements.breakDuration.textContent = stats.breakDuration ? 
                        `${stats.breakDuration}min` : '0min';
                }
            }

            updateBadgingButtons() {
                const status = badgingManager.getCurrentStatus();
                const buttons = {
                    checkin: document.getElementById('checkinBtn'),
                    checkout: document.getElementById('checkoutBtn'),
                    breakStart: document.getElementById('breakStartBtn'),
                    breakEnd: document.getElementById('breakEndBtn')
                };

                Object.values(buttons).forEach(btn => {
                    if (btn) {
                        btn.disabled = false;
                        btn.classList.remove('btn-success', 'btn-warning', 'btn-danger');
                        btn.classList.add('btn-secondary');
                    }
                });

                switch(status) {
                    case 'not-started':
                        if (buttons.checkin) {
                            buttons.checkin.disabled = false;
                            buttons.checkin.classList.remove('btn-secondary');
                            buttons.checkin.classList.add('btn-success');
                        }
                        if (buttons.checkout) buttons.checkout.disabled = true;
                        if (buttons.breakStart) buttons.breakStart.disabled = true;
                        if (buttons.breakEnd) buttons.breakEnd.disabled = true;
                        break;
                        
                    case 'working':
                        if (buttons.checkin) buttons.checkin.disabled = true;
                        if (buttons.checkout) {
                            buttons.checkout.disabled = false;
                            buttons.checkout.classList.remove('btn-secondary');
                            buttons.checkout.classList.add('btn-danger');
                        }
                        if (buttons.breakStart) {
                            buttons.breakStart.disabled = false;
                            buttons.breakStart.classList.remove('btn-secondary');
                            buttons.breakStart.classList.add('btn-warning');
                        }
                        if (buttons.breakEnd) buttons.breakEnd.disabled = true;
                        break;
                        
                    case 'on-break':
                        if (buttons.checkin) buttons.checkin.disabled = true;
                        if (buttons.checkout) buttons.checkout.disabled = true;
                        if (buttons.breakStart) buttons.breakStart.disabled = true;
                        if (buttons.breakEnd) {
                            buttons.breakEnd.disabled = false;
                            buttons.breakEnd.classList.remove('btn-secondary');
                            buttons.breakEnd.classList.add('btn-success');
                        }
                        break;
                        
                    case 'finished':
                        Object.values(buttons).forEach(btn => {
                            if (btn) btn.disabled = true;
                        });
                        break;
                }
            }

            updateTimesheetsTable() {
                const tbody = document.getElementById('timesheetsTableBody');
                if (!tbody) return;
                
                const timesheets = badgingManager.getTimesheets().slice(0, 10);
                
                if (timesheets.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                Aucun pointage enregistré
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = timesheets.map(timesheet => `
                    <tr>
                        <td>${new Date(timesheet.date).toLocaleDateString('fr-FR')}</td>
                        <td>${timesheet.checkIn ? timesheet.checkIn.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '-'}</td>
                        <td>${timesheet.checkOut ? timesheet.checkOut.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '-'}</td>
                        <td>${timesheet.totalHours ? `${timesheet.totalHours}h` : '-'}</td>
                        <td><span class="status-badge status-${timesheet.status}">${this.getStatusLabel(timesheet.status)}</span></td>
                        <td>${timesheet.notes || '-'}</td>
                    </tr>
                `).join('');
            }

            updateTeamView() {
                const stats = teamManager.getTeamStats();
                const members = teamManager.getMembers();
                
                if (document.getElementById('totalMembers')) {
                    document.getElementById('totalMembers').textContent = stats.total;
                    document.getElementById('activeMembers').textContent = stats.active;
                    document.getElementById('invitedMembers').textContent = stats.invited;
                    document.getElementById('totalDepartments').textContent = stats.departments;
                }
                
                this.renderMembersTable(members);
            }

            renderMembersTable(members) {
                const tbody = document.getElementById('membersTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = members.map(member => `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="user-avatar" style="width: 32px; height: 32px; font-size: 14px;">
                                    ${member.photoURL ? 
                                        `<img src="${member.photoURL}" alt="${member.displayName}">` : 
                                        (member.displayName ? member.displayName[0].toUpperCase() : 'U')
                                    }
                                </div>
                                <div>
                                    <div style="font-weight: 500;">${member.displayName || 'Sans nom'}</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">${member.email}</div>
                                </div>
                            </div>
                        </td>
                        <td><span class="status-badge status-${member.role}">${this.getRoleLabel(member.role)}</span></td>
                        <td>${member.department || '-'}</td>
                        <td>${member.position || '-'}</td>
                        <td><span class="status-badge ${member.status === 'active' ? 'status-online' : 'status-offline'}">${this.getStatusLabel(member.status)}</span></td>
                        <td>
                            <button onclick="editMember('${member.id}')" class="btn btn-sm btn-secondary" style="margin-right: 8px;">Modifier</button>
                            <button onclick="deleteMemberConfirm('${member.id}')" class="btn btn-sm btn-danger">Supprimer</button>
                        </td>
                    </tr>
                `).join('');
            }

            getRoleLabel(role) {
                const labels = { 'admin': 'Admin', 'manager': 'Manager', 'employee': 'Employé' };
                return labels[role] || role;
            }

            getStatusLabel(status) {
                const labels = { 
                    'active': 'Actif', 
                    'invited': 'Invité', 
                    'inactive': 'Inactif',
                    'present': 'Présent',
                    'absent': 'Absent',
                    'late': 'Retard'
                };
                return labels[status] || status;
            }

            renderDashboard() {
                return `
                    <div class="container">
                        ${this.renderHeader()}
                        ${this.renderNavigation('/dashboard')}
                        
                        <div class="grid grid-4">
                            <div class="stats-card">
                                <div class="stats-number">✅</div>
                                <div class="stats-label">Phase 4 Active</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number">⏰</div>
                                <div class="stats-label">BadgingManager</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number">👥</div>
                                <div class="stats-label">TeamManager</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number">🚀</div>
                                <div class="stats-label">Opérationnel</div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h2>🎉 Phase 4 - BadgingManager implémentée !</h2>
                            <p>Le système de pointage et de gestion des horaires est maintenant disponible.</p>
                            
                            <div style="margin: 20px 0;">
                                <h3>Nouvelles fonctionnalités :</h3>
                                <ul style="margin: 16px 0; padding-left: 20px; color: var(--text-secondary);">
                                    <li>⏰ Système de pointage entrée/sortie</li>
                                    <li>☕ Gestion des pauses</li>
                                    <li>📊 Calcul automatique des heures</li>
                                    <li>📋 Historique des pointages</li>
                                    <li>⌚ Horloge temps réel</li>
                                    <li>📝 Ajout de notes sur les pointages</li>
                                </ul>
                            </div>
                            
                            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                                <button onclick="router.navigate('/badging')" class="btn btn-primary">
                                    ⏰ Pointage
                                </button>
                                <button onclick="router.navigate('/team')" class="btn btn-secondary">
                                    👥 Équipe
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderBadging() {
                return `
                    <div class="container">
                        ${this.renderHeader()}
                        ${this.renderNavigation('/badging')}
                        
                        <div class="grid grid-2">
                            <!-- Widget Horloge et Pointage -->
                            <div class="clock-widget">
                                <div class="current-time" id="currentTime">--:--:--</div>
                                <div class="current-date" id="currentDate">Chargement...</div>
                                
                                <div class="badge-buttons">
                                    <button id="checkinBtn" onclick="handleCheckIn()" class="btn btn-lg btn-success">
                                        🟢 Arrivée
                                    </button>
                                    <button id="checkoutBtn" onclick="handleCheckOut()" class="btn btn-lg btn-danger">
                                        🔴 Sortie
                                    </button>
                                </div>
                                
                                <div class="badge-buttons" style="margin-top: 16px;">
                                    <button id="breakStartBtn" onclick="handleBreakStart()" class="btn btn-lg btn-warning">
                                        ⏸️ Pause
                                    </button>
                                    <button id="breakEndBtn" onclick="handleBreakEnd()" class="btn btn-lg btn-success">
                                        ▶️ Reprise
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Statistiques du jour -->
                            <div class="card">
                                <h3>📊 Aujourd'hui</h3>
                                
                                <div class="badge-status">
                                    <div class="time-label">Arrivée</div>
                                    <div class="time-display" id="checkinTime">--:--</div>
                                </div>
                                
                                <div class="badge-status">
                                    <div class="time-label">Sortie</div>
                                    <div class="time-display" id="checkoutTime">--:--</div>
                                </div>
                                
                                <div class="hours-summary">
                                    <div>
                                        <div class="time-label">Heures travaillées</div>
                                        <div class="time-display" id="totalHours">0h</div>
                                    </div>
                                    <div>
                                        <div class="time-label">Temps de pause</div>
                                        <div class="time-display" id="breakDuration">0min</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Historique des pointages -->
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2>📋 Historique des pointages</h2>
                                <button onclick="badgingManager.loadTimesheets()" class="btn btn-secondary">
                                    🔄 Actualiser
                                </button>
                            </div>
                            
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Arrivée</th>
                                            <th>Sortie</th>
                                            <th>Heures</th>
                                            <th>Statut</th>
                                            <th>Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="timesheetsTableBody">
                                        <tr>
                                            <td colspan="6" style="text-align: center; padding: 40px;">
                                                <div class="loading-spinner"></div>
                                                <p style="margin-top: 16px;">Chargement de l'historique...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderTeam() {
                return `
                    <div class="container">
                        ${this.renderHeader()}
                        ${this.renderNavigation('/team')}
                        
                        <div class="grid grid-3">
                            <div class="stats-card">
                                <div class="stats-number" id="totalMembers">0</div>
                                <div class="stats-label">Total Membres</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number" id="activeMembers">0</div>
                                <div class="stats-label">Membres Actifs</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number" id="invitedMembers">0</div>
                                <div class="stats-label">Invitations</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number" id="totalDepartments">0</div>
                                <div class="stats-label">Départements</div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2>👥 Gestion d'équipe</h2>
                                <button onclick="openAddMemberModal()" class="btn btn-primary">
                                    + Ajouter un membre
                                </button>
                            </div>
                            
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Membre</th>
                                            <th>Rôle</th>
                                            <th>Département</th>
                                            <th>Poste</th>
                                            <th>Statut</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="membersTableBody">
                                        <tr>
                                            <td colspan="6" style="text-align: center; padding: 40px;">
                                                <div class="loading-spinner"></div>
                                                <p style="margin-top: 16px;">Chargement des membres...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderLogin() {
                return `
                    <div class="container">
                        <div style="max-width: 400px; margin: 100px auto;">
                            <div class="card" style="text-align: center;">
                                <h1>🔐 Connexion SYNERGIA</h1>
                                <p style="margin: 20px 0; color: var(--text-secondary);">
                                    Connectez-vous pour accéder à votre espace de travail.
                                </p>
                                <button onclick="handleGoogleLogin()" class="btn btn-primary" style="width: 100%; margin: 10px 0;">
                                    🚀 Connexion avec Google
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderProfile() {
                const user = authManager.getCurrentUser();
                const profile = authManager.getUserProfile();
                
                return `
                    <div class="container">
                        ${this.renderHeader()}
                        ${this.renderNavigation('/profile')}
                        
                        <div class="card">
                            <h2>👤 Profil utilisateur</h2>
                            <div style="margin: 20px 0;">
                                <p><strong>Nom d'affichage:</strong> ${user.displayName || 'Non défini'}</p>
                                <p><strong>Email:</strong> ${user.email}</p>
                                <p><strong>Rôle:</strong> ${profile?.role || 'employee'}</p>
                                <p><strong>Département:</strong> ${profile?.department || 'Non défini'}</p>
                                <p><strong>Poste:</strong> ${profile?.position || 'Non défini'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderHeader() {
                const user = authManager.getCurrentUser();
                
                return `
                    <div class="header">
                        <h1>🚀 SYNERGIA v3.0</h1>
                        <div class="user-profile">
                            <div class="user-avatar">
                                ${user.photoURL ? 
                                    `<img src="${user.photoURL}" alt="${user.displayName}">` : 
                                    (user.displayName ? user.displayName[0].toUpperCase() : 'U')
                                }
                            </div>
                            <div>
                                <div style="font-weight: 500;">${user.displayName || 'Utilisateur'}</div>
                                <div style="font-size: 14px; color: var(--text-secondary);">${user.email}</div>
                            </div>
                            <button onclick="handleSignOut()" class="btn btn-secondary" style="margin-left: 12px;">Déconnexion</button>
                        </div>
                    </div>
                `;
            }

            renderNavigation(activePath) {
                return `
                    <div class="nav-tabs">
                        <a href="#/dashboard" class="nav-tab ${activePath === '/dashboard' ? 'active' : ''}">📊 Dashboard</a>
                        <a href="#/profile" class="nav-tab ${activePath === '/profile' ? 'active' : ''}">👤 Profil</a>
                        <a href="#/team" class="nav-tab ${activePath === '/team' ? 'active' : ''}">👥 Équipe</a>
                        <a href="#/badging" class="nav-tab ${activePath === '/badging' ? 'active' : ''}">⏰ Pointage</a>
                        <button class="nav-tab" onclick="alert('Phase 5 - Bientôt disponible!')">💬 Chat</button>
                        <button class="nav-tab" onclick="alert('Phase 6 - Bientôt disponible!')">📅 Planning</button>
                    </div>
                `;
            }

            render404() {
                return `
                    <div class="container">
                        <div class="card" style="text-align: center;">
                            <h1>404 - Page non trouvée</h1>
                            <button onclick="router.navigate('/dashboard')" class="btn btn-primary">Retour à l'accueil</button>
                        </div>
                    </div>
                `;
            }

            init() {
                console.log('🧭 Initialisation Router...');
                window.addEventListener('hashchange', () => this.render());
                
                const waitForAuth = () => {
                    if (window.authManager && window.authManager.isInitialized) {
                        console.log('✅ Router prêt - premier rendu');
                        this.render();
                    } else {
                        setTimeout(waitForAuth, 100);
                    }
                };
                
                waitForAuth();
                
                // Event listeners pour les managers
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Team events
                window.addEventListener('team:loaded', () => {
                    if (window.location.hash.includes('/team')) {
                        this.updateTeamView();
                    }
                });

                window.addEventListener('member:added', () => {
                    if (window.location.hash.includes('/team')) {
                        this.loadTeamData();
                    }
                });

                window.addEventListener('member:updated', () => {
                    if (window.location.hash.includes('/team')) {
                        this.loadTeamData();
                    }
                });

                window.addEventListener('member:deleted', () => {
                    if (window.location.hash.includes('/team')) {
                        this.loadTeamData();
                    }
                });

                // Badging events
                window.addEventListener('timesheet:loaded', () => {
                    if (window.location.hash.includes('/badging')) {
                        this.updateBadgingView();
                    }
                });

                window.addEventListener('badge:checkin', () => {
                    if (window.location.hash.includes('/badging')) {
                        this.updateBadgingView();
                    }
                });

                window.addEventListener('badge:checkout', () => {
                    if (window.location.hash.includes('/badging')) {
                        this.updateBadgingView();
                    }
                });

                window.addEventListener('badge:breakstart', () => {
                    if (window.location.hash.includes('/badging')) {
                        this.updateBadgingView();
                    }
                });

                window.addEventListener('badge:breakend', () => {
                    if (window.location.hash.includes('/badging')) {
                        this.updateBadgingView();
                    }
                });
            }
        }

        window.router = new Router();
    </script>

    <!-- ================================ -->
    <!-- FONCTIONS D'INTERACTION          -->
    <!-- ================================ -->
    <script>
        // Variables globales pour les modales de pointage
        let pendingBadgeAction = null;

        // ==================
        // FONCTIONS D'AUTHENTIFICATION
        // ==================
        async function handleGoogleLogin() {
            try {
                await authManager.signInWithGoogle();
                router.navigate('/dashboard');
            } catch (error) {
                alert('Erreur de connexion: ' + error.message);
            }
        }

        async function handleSignOut() {
            try {
                // Arrêter l'horloge si elle tourne
                if (window.badgingManager) {
                    badgingManager.stopClock();
                }
                await authManager.signOut();
                router.navigate('/login');
            } catch (error) {
                alert('Erreur de déconnexion: ' + error.message);
            }
        }

        // ==================
        // FONCTIONS DE POINTAGE
        // ==================
        function handleCheckIn() {
            pendingBadgeAction = 'checkin';
            openBadgeNoteModal('Pointage d\'arrivée', 'Ajouter une note pour votre arrivée (optionnel)');
        }

        function handleCheckOut() {
            pendingBadgeAction = 'checkout';
            openBadgeNoteModal('Pointage de sortie', 'Ajouter une note pour votre sortie (optionnel)');
        }

        function handleBreakStart() {
            pendingBadgeAction = 'breakstart';
            openBadgeNoteModal('Début de pause', 'Motif de la pause (optionnel)');
        }

        function handleBreakEnd() {
            pendingBadgeAction = 'breakend';
            openBadgeNoteModal('Fin de pause', 'Retour de pause');
        }

        // ==================
        // GESTION DES MODALES
        // ==================
        function openBadgeNoteModal(title, placeholder = '') {
            const modal = document.getElementById('badgeNoteModal');
            const titleElement = modal.querySelector('.modal-title');
            const noteInput = document.getElementById('badgeNote');
            
            if (titleElement) titleElement.textContent = title;
            if (noteInput) {
                noteInput.value = '';
                noteInput.placeholder = placeholder;
            }
            
            modal.classList.add('show');
            
            setTimeout(() => {
                if (noteInput) noteInput.focus();
            }, 100);
        }

        function closeBadgeNoteModal() {
            const modal = document.getElementById('badgeNoteModal');
            modal.classList.remove('show');
            pendingBadgeAction = null;
        }

        async function executeBadgeAction() {
            if (!pendingBadgeAction) return;

            try {
                const note = document.getElementById('badgeNote').value.trim();
                let result;

                const submitBtn = document.querySelector('#badgeNoteForm button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Enregistrement...';
                submitBtn.disabled = true;

                switch(pendingBadgeAction) {
                    case 'checkin':
                        result = await badgingManager.checkIn(note);
                        break;
                    case 'checkout':
                        result = await badgingManager.checkOut(note);
                        break;
                    case 'breakstart':
                        result = await badgingManager.startBreak(note);
                        break;
                    case 'breakend':
                        result = await badgingManager.endBreak(note);
                        break;
                }

                if (result) {
                    closeBadgeNoteModal();
                    
                    const messages = {
                        'checkin': 'Arrivée enregistrée avec succès !',
                        'checkout': 'Sortie enregistrée avec succès !',
                        'breakstart': 'Début de pause enregistré !',
                        'breakend': 'Fin de pause enregistrée !'
                    };
                    
                    alert(messages[pendingBadgeAction]);
                }

                submitBtn.textContent = originalText;
                submitBtn.disabled = false;

            } catch (error) {
                console.error('Erreur lors du pointage:', error);
                alert('Erreur: ' + error.message);
                
                const submitBtn = document.querySelector('#badgeNoteForm button[type="submit"]');
                submitBtn.textContent = 'Confirmer';
                submitBtn.disabled = false;
            }
        }

        // ==================
        // FONCTIONS ÉQUIPE
        // ==================
        function openAddMemberModal() {
            document.getElementById('modalTitle').textContent = 'Ajouter un membre';
            document.getElementById('teamForm').reset();
            document.getElementById('teamModal').classList.add('show');
        }

        function closeTeamModal() {
            document.getElementById('teamModal').classList.remove('show');
        }

        async function editMember(memberId) {
            const members = teamManager.getMembers();
            const member = members.find(m => m.id === memberId);
            
            if (!member) return;
            
            document.getElementById('modalTitle').textContent = 'Modifier le membre';
            document.getElementById('memberEmail').value = member.email;
            document.getElementById('memberName').value = member.displayName || '';
            document.getElementById('memberRole').value = member.role || 'employee';
            document.getElementById('memberDepartment').value = member.department || '';
            document.getElementById('memberPosition').value = member.position || '';
            
            document.getElementById('teamForm').dataset.editId = memberId;
            document.getElementById('teamModal').classList.add('show');
        }

        async function deleteMemberConfirm(memberId) {
            const members = teamManager.getMembers();
            const member = members.find(m => m.id === memberId);
            
            if (!member) return;
            
            if (confirm(`Êtes-vous sûr de vouloir supprimer ${member.displayName || member.email} ?`)) {
                try {
                    await teamManager.deleteMember(memberId);
                    alert('Membre supprimé avec succès');
                } catch (error) {
                    alert('Erreur lors de la suppression: ' + error.message);
                }
            }
        }

        // ==================
        // INITIALISATION
        // ==================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 SYNERGIA v3.0 Phase 4 - BadgingManager chargé');

            // Gestionnaire du formulaire d'équipe
            const teamForm = document.getElementById('teamForm');
            if (teamForm) {
                teamForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = {
                        email: document.getElementById('memberEmail').value,
                        displayName: document.getElementById('memberName').value,
                        role: document.getElementById('memberRole').value,
                        department: document.getElementById('memberDepartment').value,
                        position: document.getElementById('memberPosition').value
                    };
                    
                    try {
                        const editId = teamForm.dataset.editId;
                        
                        if (editId) {
                            await teamManager.updateMember(editId, formData);
                            alert('Membre modifié avec succès');
                            delete teamForm.dataset.editId;
                        } else {
                            await teamManager.addMember(formData);
                            alert('Membre ajouté avec succès');
                        }
                        
                        closeTeamModal();
                    } catch (error) {
                        alert('Erreur: ' + error.message);
                    }
                });
            }

            // Gestionnaire du formulaire de note de pointage
            const badgeNoteForm = document.getElementById('badgeNoteForm');
            if (badgeNoteForm) {
                badgeNoteForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await executeBadgeAction();
                });
            }
            
            // Fermer les modales en cliquant à côté
            const teamModal = document.getElementById('teamModal');
            if (teamModal) {
                teamModal.addEventListener('click', (e) => {
                    if (e.target.id === 'teamModal') {
                        closeTeamModal();
                    }
                });
            }

            const badgeNoteModal = document.getElementById('badgeNoteModal');
            if (badgeNoteModal) {
                badgeNoteModal.addEventListener('click', (e) => {
                    if (e.target.id === 'badgeNoteModal') {
                        closeBadgeNoteModal();
                    }
                });
            }

            // Raccourcis clavier
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeTeamModal();
                    closeBadgeNoteModal();
                }
                
                if (e.ctrlKey && window.location.hash.includes('/badging')) {
                    switch(e.key.toLowerCase()) {
                        case 'i':
                            e.preventDefault();
                            handleCheckIn();
                            break;
                        case 'o':
                            e.preventDefault();
                            handleCheckOut();
                            break;
                        case 'p':
                            e.preventDefault();
                            const status = badgingManager?.getCurrentStatus();
                            if (status === 'working') {
                                handleBreakStart();
                            } else if (status === 'on-break') {
                                handleBreakEnd();
                            }
                            break;
                    }
                }
            });

            // Nettoyage lors de la fermeture
            window.addEventListener('beforeunload', () => {
                if (window.badgingManager) {
                    badgingManager.stopClock();
                }
            });
        });
    </script>
</body>
</html>
