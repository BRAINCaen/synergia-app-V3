<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23e94560'/%3E%3Ctext x='50' y='60' font-family='Arial' font-size='40' fill='white' text-anchor='middle'%3ES%3C/text%3E%3C/svg%3E">
    <title>SYNERGIA v3.0</title>
    
    <!-- CSP corrig√© pour Google OAuth -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com https://www.googletagmanager.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        connect-src 'self' https://*.googleapis.com https://*.google.com https://*.firebaseapp.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firebase.googleapis.com https://content.googleapis.com https://firebaseinstallations.googleapis.com https://firebaseremoteconfig.googleapis.com https://firebaselogging-pa.googleapis.com https://region1.google-analytics.com wss://*.firebaseio.com wss://*.firebaseapp.com;
        frame-src 'self' https://accounts.google.com https://*.firebaseapp.com;
        img-src 'self' data: https:;
    ">
    
    <!-- PWA et ic√¥nes -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23e94560'/%3E%3Ctext x='50' y='60' font-family='Arial' font-size='40' fill='white' text-anchor='middle'%3ES%3C/text%3E%3C/svg%3E">
    <meta name="theme-color" content="#1a1a2e">
    
    <!-- CSS Variables (Phase 2A) -->
    <style>
        :root {
            /* Variables principales */
            --primary-color: #1a1a2e;
            --secondary-color: #16213e;
            --accent-color: #e94560;
            --text-light: #ffffff;
            --text-secondary: #b8b9ba;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-bg-strong: rgba(255, 255, 255, 0.15);
            --border-radius: 0.5rem;
            --transition: 300ms ease-in-out;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-light);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 24px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all var(--transition);
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: var(--accent-color);
            color: white;
        }
        
        .btn-secondary {
            background: var(--glass-bg);
            color: var(--text-light);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-success {
            background: #28a745;
            color: white;
        }
        
        .status-warning {
            background: #ffc107;
            color: #000;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--glass-bg-strong);
            border-radius: var(--border-radius);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            gap: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .nav-tab {
            padding: 8px 16px;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition);
        }
        
        .nav-tab.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
    </style>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="app">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Chargement de SYNERGIA v3.0...</p>
        </div>
    </div>

    <!-- Configuration Firebase -->
    <script>
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyD7uBuAQaOhZ02owkZEuMKC5Vji6PrB2f8",
            authDomain: "synergia-app-f27e7.firebaseapp.com",
            projectId: "synergia-app-f27e7",
            storageBucket: "synergia-app-f27e7.firebasestorage.app",
            messagingSenderId: "201912738922",
            appId: "1:201912738922:web:2fcc1e49293bb632899613",
            measurementId: "G-EGJ79SCMWX"
        };

        window.FIREBASE_CONFIG = FIREBASE_CONFIG;
    </script>

    <!-- Firebase Service -->
    <script>
        class FirebaseService {
            constructor() {
                this.app = null;
                this.auth = null;
                this.firestore = null;
                this.isInitialized = false;
            }

            async initialize() {
                try {
                    await this.waitForFirebase();
                    this.app = firebase.initializeApp(FIREBASE_CONFIG);
                    this.auth = firebase.auth();
                    this.firestore = firebase.firestore();
                    await this.auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                    this.isInitialized = true;
                    window.dispatchEvent(new CustomEvent('firebase:initialized'));
                } catch (error) {
                    console.error('Erreur Firebase:', error);
                    throw error;
                }
            }

            waitForFirebase() {
                return new Promise((resolve, reject) => {
                    let attempts = 0;
                    const check = () => {
                        if (typeof firebase !== 'undefined') {
                            resolve();
                        } else if (attempts < 50) {
                            attempts++;
                            setTimeout(check, 100);
                        } else {
                            reject(new Error('Firebase non disponible'));
                        }
                    };
                    check();
                });
            }

            getAuth() { return this.auth; }
            getFirestore() { return this.firestore; }
        }

        window.firebaseService = new FirebaseService();
    </script>

    <!-- AuthManager (Phase 2B) -->
    <script>
        class AuthManager {
            constructor() {
                this.currentUser = null;
                this.userProfile = null;
                this.listeners = new Set();
                this.init();
            }

            async init() {
                await firebaseService.initialize();
                this.auth = firebaseService.getAuth();
                this.firestore = firebaseService.getFirestore();
                
                this.auth.onAuthStateChanged((user) => {
                    this.handleAuthStateChange(user);
                });
            }

            async handleAuthStateChange(user) {
                this.currentUser = user;
                
                if (user) {
                    await this.loadUserProfile(user.uid);
                    this.emit('user:login', { user, profile: this.userProfile });
                } else {
                    this.userProfile = null;
                    this.emit('user:logout');
                }
                
                this.emit('auth:stateChanged', {
                    user: this.currentUser,
                    profile: this.userProfile,
                    isAuthenticated: !!user
                });
            }

            async signInWithGoogle() {
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.addScope('email');
                    provider.addScope('profile');
                    provider.setCustomParameters({ prompt: 'select_account' });
                    
                    const result = await this.auth.signInWithPopup(provider);
                    await this.createOrUpdateUserProfile(result.user);
                    
                    return { success: true, user: result.user };
                } catch (error) {
                    console.error('Erreur connexion Google:', error);
                    throw error;
                }
            }

            async signOut() {
                try {
                    await this.auth.signOut();
                    return { success: true };
                } catch (error) {
                    console.error('Erreur d√©connexion:', error);
                    throw error;
                }
            }

            async loadUserProfile(uid) {
                try {
                    const doc = await this.firestore.collection('users').doc(uid).get();
                    if (doc.exists) {
                        this.userProfile = { id: uid, ...doc.data() };
                    } else {
                        await this.createUserProfile(this.currentUser);
                    }
                } catch (error) {
                    console.error('Erreur chargement profil:', error);
                }
            }

            async createOrUpdateUserProfile(user) {
                const userRef = this.firestore.collection('users').doc(user.uid);
                const userData = {
                    email: user.email,
                    displayName: user.displayName || '',
                    photoURL: user.photoURL || '',
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    await userRef.set(userData, { merge: true });
                    await this.loadUserProfile(user.uid);
                } catch (error) {
                    console.error('Erreur mise √† jour profil:', error);
                }
            }

            async createUserProfile(user) {
                const userData = {
                    email: user.email,
                    displayName: user.displayName || '',
                    photoURL: user.photoURL || '',
                    role: 'employee',
                    xp: 0,
                    level: 1,
                    preferences: { theme: 'dark', notifications: true },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await this.firestore.collection('users').doc(user.uid).set(userData);
                this.userProfile = { id: user.uid, ...userData };
            }

            isAuthenticated() {
                return !!this.currentUser;
            }

            getCurrentUser() {
                return this.currentUser;
            }

            getUserProfile() {
                return this.userProfile;
            }

            on(event, callback) {
                this.listeners.add({ event, callback });
                window.addEventListener(event, callback);
            }

            off(event, callback) {
                window.removeEventListener(event, callback);
                this.listeners.delete({ event, callback });
            }

            emit(eventName, data) {
                window.dispatchEvent(new CustomEvent(eventName, { detail: data }));
            }
        }

        window.authManager = new AuthManager();
    </script>

    <!-- Router am√©lior√© -->
    <script>
        class Router {
            constructor() {
                this.currentPath = '/';
                this.init();
            }

            navigate(path) {
                window.location.hash = path;
                this.render();
            }

            render() {
                const hash = window.location.hash.slice(1) || '/';
                const app = document.getElementById('app');
                
                // V√©rifier l'authentification
                const isAuthenticated = authManager.isAuthenticated();
                
                switch(hash) {
                    case '/':
                    case '/dashboard':
                        if (isAuthenticated) {
                            app.innerHTML = this.renderDashboard();
                        } else {
                            this.navigate('/login');
                        }
                        break;
                    case '/login':
                        app.innerHTML = this.renderLogin();
                        break;
                    case '/profile':
                        if (isAuthenticated) {
                            app.innerHTML = this.renderProfile();
                        } else {
                            this.navigate('/login');
                        }
                        break;
                    default:
                        app.innerHTML = this.render404();
                }
            }

            renderDashboard() {
                const user = authManager.getCurrentUser();
                const profile = authManager.getUserProfile();
                
                return `
                    <div class="container">
                        <div class="header">
                            <h1>üöÄ SYNERGIA v3.0</h1>
                            <div class="user-profile">
                                <div class="user-avatar">${user.displayName ? user.displayName[0].toUpperCase() : 'U'}</div>
                                <div>
                                    <div style="font-weight: 500;">${user.displayName || 'Utilisateur'}</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">${user.email}</div>
                                </div>
                                <button onclick="handleSignOut()" class="btn btn-secondary" style="margin-left: 12px;">D√©connexion</button>
                            </div>
                        </div>
                        
                        <div class="nav-tabs">
                            <button class="nav-tab active" onclick="router.navigate('/dashboard')">Dashboard</button>
                            <button class="nav-tab" onclick="router.navigate('/profile')">Profil</button>
                            <button class="nav-tab" onclick="alert('Bient√¥t disponible!')">√âquipe</button>
                            <button class="nav-tab" onclick="alert('Bient√¥t disponible!')">Badging</button>
                        </div>
                        
                        <div class="card">
                            <h2>‚úÖ Migration Phase 2 - Succ√®s !</h2>
                            <p>AuthManager modulaire int√©gr√© avec succ√®s.</p>
                            <div style="margin: 20px 0;">
                                <span class="status-badge status-success">‚úÖ Firebase connect√©</span>
                                <span class="status-badge status-success">‚úÖ Utilisateur authentifi√©</span>
                                <span class="status-badge status-success">‚úÖ Profil charg√©</span>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3>üìä Informations utilisateur</h3>
                            <p><strong>Email:</strong> ${user.email}</p>
                            <p><strong>Nom:</strong> ${user.displayName || 'Non d√©fini'}</p>
                            <p><strong>UID:</strong> ${user.uid}</p>
                            <p><strong>Profil charg√©:</strong> ${profile ? '‚úÖ Oui' : '‚ùå Non'}</p>
                            ${profile ? `<p><strong>R√¥le:</strong> ${profile.role || 'Non d√©fini'}</p>` : ''}
                        </div>
                        
                        <div class="card">
                            <h3>üéØ Prochaines √©tapes</h3>
                            <ul style="margin: 16px 0; padding-left: 20px;">
                                <li>‚úÖ Phase 1: Structure de base (Termin√©)</li>
                                <li>‚úÖ Phase 2: AuthManager modulaire (Termin√©)</li>
                                <li>üîÑ Phase 3: TeamManager (En cours)</li>
                                <li>‚è≥ Phase 4: BadgingManager</li>
                                <li>‚è≥ Phase 5: ChatManager</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            renderLogin() {
                return `
                    <div class="container">
                        <div style="max-width: 400px; margin: 100px auto;">
                            <div class="card" style="text-align: center;">
                                <h1>üîê Connexion SYNERGIA</h1>
                                <p style="margin: 20px 0; color: var(--text-secondary);">
                                    Connectez-vous pour acc√©der √† votre espace de travail.
                                </p>
                                <button onclick="handleGoogleLogin()" class="btn btn-primary" style="width: 100%; margin: 10px 0;">
                                    üöÄ Connexion avec Google
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderProfile() {
                const user = authManager.getCurrentUser();
                const profile = authManager.getUserProfile();
                
                return `
                    <div class="container">
                        <div class="header">
                            <h1>üë§ Profil utilisateur</h1>
                            <button onclick="router.navigate('/dashboard')" class="btn btn-secondary">‚Üê Retour</button>
                        </div>
                        
                        <div class="card">
                            <h2>Informations personnelles</h2>
                            <div style="margin: 20px 0;">
                                <p><strong>Nom d'affichage:</strong> ${user.displayName || 'Non d√©fini'}</p>
                                <p><strong>Email:</strong> ${user.email}</p>
                                <p><strong>Photo:</strong> ${user.photoURL ? '‚úÖ Oui' : '‚ùå Non'}</p>
                                <p><strong>Email v√©rifi√©:</strong> ${user.emailVerified ? '‚úÖ Oui' : '‚ùå Non'}</p>
                            </div>
                        </div>
                        
                        ${profile ? `
                            <div class="card">
                                <h2>Profil SYNERGIA</h2>
                                <p><strong>R√¥le:</strong> ${profile.role || 'Non d√©fini'}</p>
                                <p><strong>Niveau:</strong> ${profile.level || 1}</p>
                                <p><strong>XP:</strong> ${profile.xp || 0}</p>
                                <p><strong>Membre depuis:</strong> ${profile.createdAt ? new Date(profile.createdAt.seconds * 1000).toLocaleDateString() : 'Inconnu'}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            render404() {
                return `
                    <div class="container">
                        <div class="card" style="text-align: center;">
                            <h1>404 - Page non trouv√©e</h1>
                            <button onclick="router.navigate('/dashboard')" class="btn btn-primary">Retour √† l'accueil</button>
                        </div>
                    </div>
                `;
            }

            init() {
                window.addEventListener('hashchange', () => this.render());
                
                // Attendre que l'AuthManager soit pr√™t
                authManager.on('auth:stateChanged', () => {
                    this.render();
                });
            }
        }

        window.router = new Router();
    </script>

    <!-- Fonctions d'interaction -->
    <script>
        async function handleGoogleLogin() {
            try {
                await authManager.signInWithGoogle();
                router.navigate('/dashboard');
            } catch (error) {
                alert('Erreur de connexion: ' + error.message);
            }
        }

        async function handleSignOut() {
            try {
                await authManager.signOut();
                router.navigate('/login');
            } catch (error) {
                alert('Erreur de d√©connexion: ' + error.message);
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ SYNERGIA v3.0 - Phase 2 charg√©e');
        });
    </script>
</body>
</html>
