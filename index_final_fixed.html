<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYNERGIA v3.0</title>
    
    <!-- CSP optimis√© -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com https://www.googletagmanager.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com;
        style-src-elem 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com;
        font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;
        connect-src 'self' https://*.googleapis.com https://*.google.com https://*.firebaseapp.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firebase.googleapis.com https://content.googleapis.com https://firebaseinstallations.googleapis.com https://firebaseremoteconfig.googleapis.com https://firebaselogging-pa.googleapis.com https://region1.google-analytics.com wss://*.firebaseio.com wss://*.firebaseapp.com;
        frame-src 'self' https://accounts.google.com https://*.firebaseapp.com;
        img-src 'self' data: https: blob: *.googleusercontent.com *.googleapis.com *.gstatic.com;
    ">
    
    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23e94560'/%3E%3Ctext x='50' y='60' font-family='Arial' font-size='40' fill='white' text-anchor='middle'%3ES%3C/text%3E%3C/svg%3E">
    <meta name="theme-color" content="#1a1a2e">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Styles int√©gr√©s pour √©viter les erreurs 404 -->
    <style>
        /* Variables CSS */
        :root {
            --primary-color: #1a1a2e;
            --secondary-color: #16213e;
            --accent-color: #e94560;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            
            --text-light: #ffffff;
            --text-secondary: #b8b9ba;
            --text-muted: #8a8b8c;
            
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-bg-strong: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            
            --border-radius: 0.5rem;
            --border-radius-lg: 1rem;
            --transition: 300ms ease-in-out;
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-light);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 24px;
            margin: 20px 0;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
            transition: all var(--transition);
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.5);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all var(--transition);
            text-decoration: none;
            display: inline-block;
            text-align: center;
            min-width: 120px;
        }
        
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: var(--accent-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-warning { background: var(--warning-color); color: #000; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-secondary { 
            background: var(--glass-bg); 
            color: var(--text-light); 
            border: 1px solid var(--glass-border); 
        }
        .btn-sm { padding: 8px 16px; font-size: 14px; min-width: auto; }
        .btn-lg { padding: 16px 32px; font-size: 18px; min-width: 180px; }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            gap: 20px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-container {
            text-align: center;
            padding: 60px 20px;
        }
        
        .error-container h2 {
            color: var(--danger-color);
            margin-bottom: 20px;
        }
        
        .module-status {
            background: var(--glass-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 20px 0;
        }
        
        .module-status ul {
            list-style: none;
            padding: 0;
        }
        
        .module-status li {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-ok { color: var(--success-color); }
        .status-error { color: var(--danger-color); }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 16px; }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Chargement de SYNERGIA v3.0...</p>
        </div>
    </div>

    <!-- Configuration Firebase -->
    <script>
        // Configuration Firebase
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyD7uBuAQaOhZ02owkZEuMKC5Vji6PrB2f8",
            authDomain: "synergia-app-f27e7.firebaseapp.com",
            projectId: "synergia-app-f27e7",
            storageBucket: "synergia-app-f27e7.firebasestorage.app",
            messagingSenderId: "201912738922",
            appId: "1:201912738922:web:2fcc1e49293bb632899613",
            measurementId: "G-EGJ79SCMWX"
        };

        window.FIREBASE_CONFIG = FIREBASE_CONFIG;
        
        // Configuration APP
        window.APP_CONFIG = {
            name: 'SYNERGIA v3.0',
            version: '3.0.4',
            environment: 'production',
            debug: true
        };
    </script>

    <!-- Chargement conditionnel des modules -->
    <script>
        // √âtat du chargement des modules
        const moduleLoadState = {
            config: false,
            firebase: false,
            auth: false,
            team: false,
            badging: false,
            router: false
        };

        // URLs des modules √† tester
        const moduleUrls = {
            config: './src/js/config.js',
            firebase: './src/js/core/firebase-service.js',
            auth: './src/js/managers/AuthManager.js',
            team: './src/js/managers/team-manager.js',
            badging: './src/js/managers/badging-manager.js',
            router: './src/js/core/router_complete_fixed.js'
        };

        // Fonction pour tester l'existence d'un fichier
        async function fileExists(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                return response.ok;
            } catch {
                return false;
            }
        }

        // Fonction pour charger un script
        function loadScript(url, id) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = url;
                script.id = id;
                script.onload = () => {
                    console.log(`‚úÖ Module charg√©: ${id}`);
                    moduleLoadState[id] = true;
                    resolve();
                };
                script.onerror = () => {
                    console.warn(`‚ùå √âchec chargement: ${id}`);
                    reject(new Error(`Failed to load ${id}`));
                };
                document.head.appendChild(script);
            });
        }

        // Fonction d'initialisation principale
        async function initializeApp() {
            console.log('üöÄ SYNERGIA v3.0 - D√©marrage...');

            try {
                // Tester la disponibilit√© des modules
                const moduleTests = await Promise.allSettled(
                    Object.entries(moduleUrls).map(async ([id, url]) => {
                        const exists = await fileExists(url);
                        return { id, url, exists };
                    })
                );

                console.log('üìã √âtat des modules:');
                moduleTests.forEach(test => {
                    if (test.status === 'fulfilled') {
                        const { id, exists } = test.value;
                        console.log(`${exists ? '‚úÖ' : '‚ùå'} ${id}: ${exists ? 'disponible' : 'manquant'}`);
                    }
                });

                // Charger les modules disponibles
                const availableModules = moduleTests
                    .filter(test => test.status === 'fulfilled' && test.value.exists)
                    .map(test => test.value);

                if (availableModules.length === 0) {
                    throw new Error('Aucun module disponible - Mode fallback');
                }

                // Charger les modules dans l'ordre
                for (const { id, url } of availableModules) {
                    try {
                        await loadScript(url, id);
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è √âchec chargement ${id}:`, error);
                    }
                }

                // Attendre un peu pour que les classes soient d√©finies
                await new Promise(resolve => setTimeout(resolve, 500));

                // Initialiser Firebase Service
                if (typeof FirebaseService !== 'undefined') {
                    window.firebaseService = new FirebaseService();
                    await window.firebaseService.waitForInitialization();
                    console.log('‚úÖ Firebase Service initialis√©');
                } else {
                    throw new Error('FirebaseService non disponible');
                }

                // Initialiser AuthManager
                if (typeof AuthManager !== 'undefined') {
                    window.authManager = new AuthManager();
                    console.log('‚úÖ Auth Manager initialis√©');
                } else {
                    console.warn('‚ö†Ô∏è AuthManager non disponible');
                }

                // Initialiser TeamManager
                if (typeof TeamManager !== 'undefined') {
                    window.teamManager = new TeamManager();
                    console.log('‚úÖ Team Manager initialis√©');
                } else {
                    console.warn('‚ö†Ô∏è TeamManager non disponible');
                }

                // Initialiser BadgingManager
                if (typeof BadgingManager !== 'undefined') {
                    window.badgingManager = new BadgingManager();
                    console.log('‚úÖ Badging Manager initialis√©');
                } else {
                    console.warn('‚ö†Ô∏è BadgingManager non disponible');
                }

                // Initialiser Router
                if (typeof Router !== 'undefined') {
                    window.router = new Router();
                    console.log('‚úÖ Router initialis√©');
                } else {
                    console.warn('‚ö†Ô∏è Router non disponible');
                    showFallbackInterface();
                }

                console.log('üéâ SYNERGIA v3.0 - Initialisation termin√©e');

            } catch (error) {
                console.error('‚ùå Erreur d\'initialisation:', error);
                showErrorInterface(error);
            }
        }

        // Interface de fallback si les modules ne sont pas disponibles
        function showFallbackInterface() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="card">
                        <h1 style="color: var(--warning-color); text-align: center;">
                            <i class="fas fa-exclamation-triangle"></i>
                            SYNERGIA v3.0 - Mode Fallback
                        </h1>
                        
                        <p style="text-align: center; margin: 20px 0;">
                            L'application fonctionne en mode d√©grad√©. Certains modules ne sont pas disponibles.
                        </p>
                        
                        <div class="module-status">
                            <h3>√âtat des modules :</h3>
                            <ul>
                                <li><i class="fas fa-check status-ok"></i> Configuration</li>
                                <li><i class="fas fa-${moduleLoadState.firebase ? 'check status-ok' : 'times status-error'}"></i> Firebase Service</li>
                                <li><i class="fas fa-${moduleLoadState.auth ? 'check status-ok' : 'times status-error'}"></i> Auth Manager</li>
                                <li><i class="fas fa-${moduleLoadState.team ? 'check status-ok' : 'times status-error'}"></i> Team Manager</li>
                                <li><i class="fas fa-${moduleLoadState.badging ? 'check status-ok' : 'times status-error'}"></i> Badging Manager</li>
                                <li><i class="fas fa-${moduleLoadState.router ? 'check status-ok' : 'times status-error'}"></i> Router</li>
                            </ul>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button onclick="location.reload()" class="btn btn-primary">
                                <i class="fas fa-sync"></i>
                                Recharger l'application
                            </button>
                            <button onclick="showDebugInfo()" class="btn btn-secondary">
                                <i class="fas fa-bug"></i>
                                Informations de debug
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Interface d'erreur
        function showErrorInterface(error) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="error-container">
                        <h2><i class="fas fa-exclamation-circle"></i> Erreur d'initialisation</h2>
                        <p>Impossible de d√©marrer SYNERGIA v3.0</p>
                        <div class="card" style="text-align: left; margin: 20px auto; max-width: 600px;">
                            <h4>D√©tails de l'erreur :</h4>
                            <pre style="background: var(--glass-bg-strong); padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 14px;">${error.message}</pre>
                        </div>
                        <button onclick="location.reload()" class="btn btn-primary">
                            <i class="fas fa-sync"></i>
                            R√©essayer
                        </button>
                    </div>
                </div>
            `;
        }

        // Fonction de debug
        function showDebugInfo() {
            const debugInfo = {
                userAgent: navigator.userAgent,
                url: window.location.href,
                moduleStates: moduleLoadState,
                timestamp: new Date().toISOString(),
                firebase: typeof firebase !== 'undefined' ? 'Disponible' : 'Non disponible',
                localStorage: typeof localStorage !== 'undefined' ? 'Disponible' : 'Non disponible'
            };

            alert('Informations de debug copi√©es dans la console');
            console.log('üêõ SYNERGIA Debug Info:', debugInfo);
        }

        // D√©marrer l'application
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Gestion des erreurs globales
        window.addEventListener('error', (e) => {
            console.error('‚ùå Erreur JavaScript:', e.error);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('‚ùå Promesse rejet√©e:', e.reason);
        });
    </script>
</body>
</html>
