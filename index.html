<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYNERGIA v3.0 - Gestion d'équipe</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, getDocs, getDoc, onSnapshot, setDoc, query, where, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAXY8_QmKpS5r6P2zNbX4UqP4WaEgOyj6M",
            authDomain: "synergia-app-f27e7.firebaseapp.com",
            projectId: "synergia-app-f27e7",
            storageBucket: "synergia-app-f27e7.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456"
        };

        // Initialisation Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Rendre disponible globalement
        window.auth = auth;
        window.db = db;
        window.firebase = { 
            auth, 
            db, 
            collection, 
            doc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            getDocs, 
            getDoc, 
            onSnapshot, 
            setDoc, 
            query, 
            where, 
            orderBy, 
            limit,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            signOut
        };

        console.log('✅ Firebase initialized');
    </script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-bolt"></i>
                <span>SYNERGIA v3.0</span>
            </div>
            <div class="nav-menu">
                <a href="#dashboard" class="nav-link active">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
                <a href="#team" class="nav-link">
                    <i class="fas fa-users"></i>
                    Équipe
                </a>
                <a href="#planning" class="nav-link">
                    <i class="fas fa-calendar"></i>
                    Planning
                </a>
                <a href="#chat" class="nav-link">
                    <i class="fas fa-comments"></i>
                    Chat
                </a>
                <a href="#quests" class="nav-link">
                    <i class="fas fa-trophy"></i>
                    Missions
                </a>
                <a href="#analytics" class="nav-link">
                    <i class="fas fa-chart-bar"></i>
                    Analytics
                </a>
            </div>
            <div class="nav-user">
                <div class="user-avatar">
                    <img src="assets/default-avatar.png" alt="Avatar" id="user-avatar">
                </div>
                <span id="user-name">Utilisateur</span>
                <button id="logout-btn" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenu principal -->
    <main class="main-content">
        <!-- Dashboard -->
        <section id="dashboard" class="content-section active">
            <div class="dashboard-header">
                <h1>Dashboard</h1>
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <div class="stat-info">
                            <h3 id="team-count">0</h3>
                            <p>Membres d'équipe</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-tasks"></i>
                        <div class="stat-info">
                            <h3 id="active-quests">0</h3>
                            <p>Missions actives</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-calendar-check"></i>
                        <div class="stat-info">
                            <h3 id="events-today">0</h3>
                            <p>Événements aujourd'hui</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-star"></i>
                        <div class="stat-info">
                            <h3 id="user-level">1</h3>
                            <p>Niveau actuel</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-widget">
                    <h3>Dernières activités</h3>
                    <div id="recent-activities">
                        <div class="activity-item">
                            <i class="fas fa-clock"></i>
                            <span>Bienvenue dans SYNERGIA v3.0!</span>
                            <small>Maintenant</small>
                        </div>
                    </div>
                </div>

                <div class="dashboard-widget">
                    <h3>Missions du jour</h3>
                    <div id="daily-quests-preview">
                        <p>Chargement des missions...</p>
                    </div>
                </div>

                <div class="dashboard-widget">
                    <h3>Équipe en ligne</h3>
                    <div id="online-team-members">
                        <p>Chargement de l'équipe...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Équipe -->
        <section id="team" class="content-section">
            <div class="section-header">
                <h1>Gestion d'équipe</h1>
                <div class="section-actions">
                    <input type="text" id="team-search" placeholder="Rechercher un membre..." class="search-input">
                    <button id="add-member-btn" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i>
                        Ajouter un membre
                    </button>
                </div>
            </div>

            <div class="team-container">
                <div id="team-members-list" class="team-grid">
                    <!-- Les membres seront chargés dynamiquement -->
                </div>
            </div>
        </section>

        <!-- Planning -->
        <section id="planning" class="content-section">
            <div class="section-header">
                <h1>Planning d'équipe</h1>
                <div class="section-actions">
                    <button id="add-event-btn" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        Nouvel événement
                    </button>
                    <button id="sync-calendar-btn" class="btn btn-secondary">
                        <i class="fas fa-sync"></i>
                        Synchroniser
                    </button>
                </div>
            </div>

            <div class="planning-container">
                <div class="calendar-header">
                    <button id="prev-month" class="btn-icon">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <h2 id="current-month">Chargement...</h2>
                    <button id="next-month" class="btn-icon">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div id="calendar" class="calendar-grid">
                    <!-- Le calendrier sera généré dynamiquement -->
                </div>
                <div id="events-list" class="events-sidebar">
                    <h3>Événements</h3>
                    <div id="events-container">
                        <!-- Les événements seront chargés dynamiquement -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Chat -->
        <section id="chat" class="content-section">
            <div class="chat-container">
                <div class="chat-sidebar">
                    <div class="chat-header">
                        <h3>Conversations</h3>
                        <button id="new-conversation-btn" class="btn-icon">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="conversations-list">
                        <!-- Les conversations seront chargées dynamiquement -->
                    </div>
                </div>

                <div class="chat-main">
                    <div class="chat-header">
                        <div class="chat-info">
                            <h3 id="current-chat-title">Sélectionnez une conversation</h3>
                            <span id="current-chat-status"></span>
                        </div>
                        <div class="chat-actions">
                            <button id="video-call-btn" class="btn-icon">
                                <i class="fas fa-video"></i>
                            </button>
                            <button id="audio-call-btn" class="btn-icon">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button id="chat-info-btn" class="btn-icon">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </div>

                    <div id="messages-container" class="messages-area">
                        <div class="welcome-message">
                            <i class="fas fa-comments"></i>
                            <h3>Bienvenue dans le chat d'équipe</h3>
                            <p>Sélectionnez une conversation ou créez-en une nouvelle pour commencer.</p>
                        </div>
                    </div>

                    <div class="message-input-container">
                        <div class="message-input">
                            <input type="text" id="message-input" placeholder="Tapez votre message...">
                            <button id="send-message-btn" class="btn-send">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Missions -->
        <section id="quests" class="content-section">
            <div class="section-header">
                <h1>Missions & Récompenses</h1>
                <div class="user-progress">
                    <div class="level-info">
                        <span id="user-level-display">Niveau 1</span>
                        <div class="xp-bar">
                            <div id="xp-progress" class="xp-fill"></div>
                        </div>
                        <span id="user-xp-display">0 XP</span>
                    </div>
                </div>
            </div>

            <div class="quests-container">
                <div class="quests-tabs">
                    <button class="quest-tab active" data-tab="daily">Quotidiennes</button>
                    <button class="quest-tab" data-tab="weekly">Hebdomadaires</button>
                    <button class="quest-tab" data-tab="special">Spéciales</button>
                    <button class="quest-tab" data-tab="completed">Terminées</button>
                </div>

                <div id="quests-list" class="quests-grid">
                    <!-- Les missions seront chargées dynamiquement -->
                </div>

                <div class="badges-section">
                    <h3>Badges obtenus</h3>
                    <div id="user-badges" class="badges-grid">
                        <!-- Les badges seront affichés dynamiquement -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Analytics -->
        <section id="analytics" class="content-section">
            <div class="section-header">
                <h1>Analytics & Rapports</h1>
                <div class="section-actions">
                    <select id="analytics-period" class="select-input">
                        <option value="week">Cette semaine</option>
                        <option value="month">Ce mois</option>
                        <option value="quarter">Ce trimestre</option>
                        <option value="year">Cette année</option>
                    </select>
                    <button id="export-data-btn" class="btn btn-secondary">
                        <i class="fas fa-download"></i>
                        Exporter
                    </button>
                </div>
            </div>

            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3>Présence d'équipe</h3>
                    <canvas id="attendance-chart"></canvas>
                    <div class="chart-actions">
                        <button class="btn-small" onclick="analyticsManager.switchView('attendance', 'day')">Jour</button>
                        <button class="btn-small" onclick="analyticsManager.switchView('attendance', 'week')">Semaine</button>
                        <button class="btn-small" onclick="analyticsManager.switchView('attendance', 'month')">Mois</button>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3>Progression XP</h3>
                    <canvas id="xp-chart"></canvas>
                </div>

                <div class="analytics-card">
                    <h3>Missions complétées</h3>
                    <canvas id="quests-chart"></canvas>
                </div>

                <div class="analytics-card">
                    <h3>Statistiques globales</h3>
                    <div class="stats-grid">
                        <div class="stat">
                            <span class="stat-value" id="total-members">0</span>
                            <span class="stat-label">Membres</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="total-quests">0</span>
                            <span class="stat-label">Missions</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="total-events">0</span>
                            <span class="stat-label">Événements</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="avg-attendance">0%</span>
                            <span class="stat-label">Présence moyenne</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="reports-section">
                <h3>Rapports détaillés</h3>
                <div class="reports-grid">
                    <div class="report-card" onclick="analyticsManager.generateReport('attendance')">
                        <i class="fas fa-chart-line"></i>
                        <h4>Rapport de présence</h4>
                        <p>Analyse détaillée des heures de présence</p>
                    </div>
                    <div class="report-card" onclick="analyticsManager.generateReport('performance')">
                        <i class="fas fa-trophy"></i>
                        <h4>Performance d'équipe</h4>
                        <p>Missions, XP et progression</p>
                    </div>
                    <div class="report-card" onclick="analyticsManager.generateReport('engagement')">
                        <i class="fas fa-users"></i>
                        <h4>Engagement</h4>
                        <p>Participation et interaction</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <!-- Modal ajout de membre -->
    <div id="add-member-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Ajouter un nouveau membre</h2>
            <form id="add-member-form">
                <div class="form-group">
                    <label for="member-name">Nom complet</label>
                    <input type="text" id="member-name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="member-email">Email</label>
                    <input type="email" id="member-email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="member-role">Rôle</label>
                    <select id="member-role" name="role" required>
                        <option value="Membre">Membre</option>
                        <option value="Développeur">Développeur</option>
                        <option value="Designer">Designer</option>
                        <option value="Manager">Manager</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancel-add-member" class="btn btn-secondary">Annuler</button>
                    <button type="submit" class="btn btn-primary">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal ajout d'événement -->
    <div id="add-event-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Nouvel événement</h2>
            <form id="add-event-form">
                <div class="form-group">
                    <label for="event-title">Titre</label>
                    <input type="text" id="event-title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="event-description">Description</label>
                    <textarea id="event-description" name="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="event-date">Date</label>
                    <input type="date" id="event-date" name="date" required>
                </div>
                <div class="form-group">
                    <label for="event-time">Heure</label>
                    <input type="time" id="event-time" name="time" required>
                </div>
                <div class="form-group">
                    <label for="event-type">Type</label>
                    <select id="event-type" name="type">
                        <option value="meeting">Réunion</option>
                        <option value="deadline">Échéance</option>
                        <option value="event">Événement</option>
                        <option value="reminder">Rappel</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary">Annuler</button>
                    <button type="submit" class="btn btn-primary">Créer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="quest-manager.js"></script>
    
    <script>
        console.log('🚀 Initializing SYNERGIA v3.0...');

        // Variables globales
        let currentUser = null;
        let teamManager = null;
        let planningManager = null;
        let chatManager = null;
        let analyticsManager = null;
        let badgingManager = null;

        // Attendre que Firebase soit prêt
        function waitForFirebase() {
            return new Promise((resolve) => {
                if (window.auth && window.db) {
                    resolve();
                } else {
                    setTimeout(() => waitForFirebase().then(resolve), 100);
                }
            });
        }

        // Gestion de l'authentification
        function handleAuthStateChange(user) {
            if (user) {
                currentUser = user;
                console.log(`👤 Utilisateur connecté: ${user.email}`);
                updateUserInfo(user);
                initializeManagers();
            } else {
                console.log('👤 Aucun utilisateur connecté');
                // Rediriger vers la page de connexion ou initialiser en mode démo
                initializeDemoMode();
            }
        }

        function updateUserInfo(user) {
            const userName = document.getElementById('user-name');
            const userAvatar = document.getElementById('user-avatar');
            
            if (userName) userName.textContent = user.displayName || user.email;
            if (userAvatar) userAvatar.src = user.photoURL || 'assets/default-avatar.png';
            
            console.log('✅ Utilisateur mis à jour');
        }

        function initializeDemoMode() {
            console.log('🎭 Mode démonstration activé');
            currentUser = {
                uid: 'demo-user',
                email: 'demo@synergia.com',
                displayName: 'Utilisateur Démo'
            };
            updateUserInfo(currentUser);
            initializeManagers();
        }

        // Initialisation des managers
        async function initializeManagers() {
            try {
                // Team Manager
                teamManager = new TeamManager();
                
                // Planning Manager
                planningManager = new PlanningManager();
                
                // Chat Manager
                chatManager = new ChatManager();
                
                // Analytics Manager
                analyticsManager = new AnalyticsManager();
                
                // Badging Manager
                badgingManager = new BadgingManager();
                
                // Quest Manager déjà initialisé globalement
                if (window.questManager) {
                    await window.questManager.init();
                }
                
                console.log('✅ SYNERGIA v3.0 initialized successfully!');
                
            } catch (error) {
                console.error('❌ Erreur lors de l\'initialisation:', error);
            }
        }

        // Team Manager
        class TeamManager {
            constructor() {
                this.members = [];
                this.currentUser = null;
                this.init();
            }

            async init() {
                console.log('✅ Team Manager initialisé');
                await this.loadMembers();
                this.setupEventListeners();
            }

            async loadMembers() {
                try {
                    const user = auth.currentUser;
                    if (!user) {
                        console.log('❌ Utilisateur non connecté pour charger les membres');
                        this.loadDemoMembers();
                        return;
                    }

                    const membersRef = collection(db, 'teams', user.uid, 'members');
                    const snapshot = await getDocs(membersRef);
                    
                    this.members = [];
                    snapshot.forEach(doc => {
                        const memberData = doc.data();
                        this.members.push({
                            id: doc.id,
                            name: memberData.name || '',
                            email: memberData.email || '',
                            role: memberData.role || 'Membre',
                            avatar: memberData.avatar || 'assets/default-avatar.png',
                            status: memberData.status || 'offline',
                            joinDate: memberData.joinDate || new Date(),
                            xp: memberData.xp || 0,
                            level: memberData.level || 1,
                            badges: memberData.badges || []
                        });
                    });

                    console.log(`✅ ${this.members.length} membres chargés depuis Firebase`);
                    this.renderMembers();
                } catch (error) {
                    console.error('❌ Erreur lors du chargement des membres:', error);
                    this.loadDemoMembers();
                }
            }

            loadDemoMembers() {
                this.members = [
                    {
                        id: 'demo1',
                        name: 'Allan Boehme',
                        email: 'alan.boehme61@gmail.com',
                        role: 'Manager',
                        avatar: 'assets/avatars/alan.jpg',
                        status: 'online',
                        joinDate: new Date('2024-01-15'),
                        xp: 1250,
                        level: 5,
                        badges: ['early_bird', 'team_player', 'innovator']
                    },
                    {
                        id: 'demo2',
                        name: 'Polar Caron',
                        email: 'polar.caron@synergia.com',
                        role: 'Développeur',
                        avatar: 'assets/avatars/polar.jpg',
                        status: 'online',
                        joinDate: new Date('2024-02-01'),
                        xp: 980,
                        level: 4,
                        badges: ['code_master', 'team_player']
                    },
                    {
                        id: 'demo3',
                        name: 'Marie Dubois',
                        email: 'marie.dubois@synergia.com',
                        role: 'Designer',
                        avatar: 'assets/avatars/marie.jpg',
                        status: 'away',
                        joinDate: new Date('2024-03-10'),
                        xp: 750,
                        level: 3,
                        badges: ['creative', 'perfectionist']
                    }
                ];
                console.log(`👥 ${this.members.length} membres d'équipe chargés`);
                this.renderMembers();
            }

            setupEventListeners() {
                const searchInput = document.getElementById('team-search');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.filterAndRenderMembers(e.target.value);
                    });
                }

                const addMemberBtn = document.getElementById('add-member-btn');
                if (addMemberBtn) {
                    addMemberBtn.addEventListener('click', () => {
                        this.showAddMemberModal();
                    });
                }
            }

            filterAndRenderMembers(searchTerm = '') {
                console.log('🔍 Debug membres:', {
                    membersExists: !!this.members,
                    membersType: typeof this.members,
                    membersLength: this.members ? this.members.length : 'N/A',
                    membersContent: this.members
                });

                try {
                    if (!this.members || !Array.isArray(this.members)) {
                        console.warn('⚠️ Membres invalides');
                        this.renderMembers([]);
                        return;
                    }

                    const filteredMembers = this.members.filter(member => {
                        if (!member) {
                            return false;
                        }
                        
                        const memberName = member.name || '';
                        const memberEmail = member.email || '';
                        const memberRole = member.role || '';
                        
                        const searchText = searchTerm || '';
                        
                        return memberName.toString().toLowerCase().includes(searchText.toLowerCase()) ||
                               memberEmail.toString().toLowerCase().includes(searchText.toLowerCase()) ||
                               memberRole.toString().toLowerCase().includes(searchText.toLowerCase());
                    });
                    
                    this.renderMembers(filteredMembers);
                    
                } catch (error) {
                    console.error('❌ Erreur dans filterAndRenderMembers:', error);
                    this.renderMembers(this.members || []);
                }
            }

            renderMembers(membersToRender = this.members) {
                const container = document.getElementById('team-members-list');
                if (!container) {
                    console.warn('⚠️ Container team-members-list non trouvé');
                    return;
                }

                container.innerHTML = '';

                if (membersToRender.length === 0) {
                    container.innerHTML = `
                        <div class="no-members">
                            <i class="fas fa-users"></i>
                            <p>Aucun membre trouvé</p>
                        </div>
                    `;
                    return;
                }

                membersToRender.forEach(member => {
                    const memberCard = this.createMemberCard(member);
                    container.appendChild(memberCard);
                });

                console.log(`👥 ${membersToRender.length} membres d'équipe chargés`);
            }

            createMemberCard(member) {
                const card = document.createElement('div');
                card.className = 'team-member-card';
                card.dataset.memberId = member.id;

                const statusClass = member.status === 'online' ? 'online' : 
                                   member.status === 'away' ? 'away' : 'offline';

                card.innerHTML = `
                    <div class="member-avatar">
                        <img src="${member.avatar}" alt="${member.name}" onerror="this.src='assets/default-avatar.png'">
                        <div class="status-indicator ${statusClass}"></div>
                    </div>
                    <div class="member-info">
                        <h3>${member.name}</h3>
                        <p class="member-role">${member.role}</p>
                        <p class="member-email">${member.email}</p>
                        <div class="member-stats">
                            <span class="member-level">Niveau ${member.level}</span>
                            <span class="member-xp">${member.xp} XP</span>
                        </div>
                        <div class="member-badges">
                            ${member.badges.map(badge => `<span class="badge ${badge}">${this.getBadgeName(badge)}</span>`).join('')}
                        </div>
                    </div>
                    <div class="member-actions">
                        <button class="btn-icon" onclick="teamManager.sendMessage('${member.id}')" title="Envoyer un message">
                            <i class="fas fa-envelope"></i>
                        </button>
                        <button class="btn-icon" onclick="teamManager.showMemberOptions('${member.id}')" title="Plus d'options">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                `;

                return card;
            }

            getBadgeName(badgeId) {
                const badges = {
                    'early_bird': 'Lève-tôt',
                    'team_player': 'Équipier',
                    'innovator': 'Innovateur',
                    'code_master': 'Maître du Code',
                    'creative': 'Créatif',
                    'perfectionist': 'Perfectionniste'
                };
                return badges[badgeId] || badgeId;
            }

            showAddMemberModal() {
                console.log('INFO: Fonctionnalité d\'ajout de membre - En développement');
            }

            sendMessage(memberId) {
                const member = this.members.find(m => m.id === memberId);
                if (member) {
                    console.log(`INFO: Message à ${member.name}`);
                }
            }

            showMemberOptions(memberId) {
                const member = this.members.find(m => m.id === memberId);
                if (member) {
                    console.log(`INFO: Options pour ${member.name}`);
                }
            }

            updateMemberXP(memberId, xpGained) {
                const member = this.members.find(m => m.id === memberId);
                if (member) {
                    member.xp += xpGained;
                    const newLevel = Math.floor(member.xp / 250) + 1;
                    if (newLevel > member.level) {
                        member.level = newLevel;
                        console.log(`🎉 ${member.name} monte au niveau ${newLevel}!`);
                    }
                    this.renderMembers();
                }
            }

            addBadgeToMember(memberId, badgeId) {
                const member = this.members.find(m => m.id === memberId);
                if (member && !member.badges.includes(badgeId)) {
                    member.badges.push(badgeId);
                    console.log(`🏆 ${member.name} obtient le badge: ${this.getBadgeName(badgeId)}`);
                    this.renderMembers();
                }
            }
        }

        // Planning Manager
        class PlanningManager {
            constructor() {
                this.events = [];
                this.currentDate = new Date();
                this.init();
            }

            async init() {
                console.log('✅ Planning Manager initialisé');
                await this.loadEvents();
                this.renderCalendar();
                this.setupEventListeners();
            }

            async loadEvents() {
                try {
                    const user = auth.currentUser;
                    if (!user) {
                        console.log('❌ Utilisateur non connecté pour charger les événements');
                        this.loadDemoEvents();
                        return;
                    }

                    // Vérifier les permissions
                    try {
                        const testQuery = query(collection(db, 'events'), limit(1));
                        await getDocs(testQuery);
                        console.log('✅ Permissions événements vérifiées');
                    } catch (permError) {
                        console.log('❌ Permissions insuffisantes pour les événements:', permError);
                        this.loadDemoEvents();
                        return;
                    }

                    const eventsRef = collection(db, 'events');
                    const snapshot = await getDocs(eventsRef);
                    
                    this.events = [];
                    snapshot.forEach(doc => {
                        this.events.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });

                    console.log(`✅ ${this.events.length} événements chargés depuis Firebase`);
                } catch (error) {
                    console.error('❌ Erreur chargement événements:', error);
                    this.loadDemoEvents();
                }
            }

            loadDemoEvents() {
                this.events = [
                    {
                        id: 'demo1',
                        title: 'Réunion équipe',
                        description: 'Point hebdomadaire d\'équipe',
                        date: new Date(2024, 11, 15, 10, 0),
                        type: 'meeting',
                        participants: ['demo1', 'demo2', 'demo3']
                    },
                    {
                        id: 'demo2',
                        title: 'Formation SYNERGIA',
                        description: 'Formation sur les nouvelles fonctionnalités',
                        date: new Date(2024, 11, 20, 14, 0),
                        type: 'event',
                        participants: ['demo1', 'demo2']
                    }
                ];
                console.log('📅 Événements de démonstration chargés');
            }

            renderCalendar() {
                // Implémentation du calendrier
                const calendar = document.getElementById('calendar');
                if (calendar) {
                    calendar.innerHTML = '<p>Calendrier en cours de développement</p>';
                }
            }

            setupEventListeners() {
                const addEventBtn = document.getElementById('add-event-btn');
                if (addEventBtn) {
                    addEventBtn.addEventListener('click', () => {
                        this.showAddEventModal();
                    });
                }

                const syncBtn = document.getElementById('sync-calendar-btn');
                if (syncBtn) {
                    syncBtn.addEventListener('click', () => {
                        this.syncCalendar();
                    });
                }
            }

            showAddEventModal() {
                console.log('INFO: Ajout d\'événement - Bientôt disponible');
            }

            async syncCalendar() {
                console.log('INFO: Synchronisation en cours...');
                // Simulation de synchronisation
                setTimeout(() => {
                    console.log('SUCCESS: Calendrier synchronisé!');
                }, 1000);
            }

            async saveEvent(eventData) {
                try {
                    if (!eventData.title) {
                        console.log('ERROR: Le titre est obligatoire');
                        return;
                    }

                    const user = auth.currentUser;
                    if (!user) {
                        console.log('WARNING: Pas d\'utilisateur connecté');
                        return;
                    }

                    const eventsRef = collection(db, 'events');
                    await addDoc(eventsRef, {
                        ...eventData,
                        createdBy: user.uid,
                        createdAt: new Date()
                    });

                    console.log('SUCCESS: Événement créé');
                    await this.loadEvents();
                } catch (error) {
                    console.log('❌ Erreur permissions événement:', error);
                    console.log('WARNING: Permissions insuffisantes. Événement sauvé localement.');
                }
            }
        }

        // Chat Manager
        class ChatManager {
            constructor() {
                this.conversations = [];
                this.currentConversation = null;
                this.messages = [];
                this.init();
            }

            async init() {
                console.log('💬 Chat Manager initialisé');
                await this.loadConversations();
                this.setupEventListeners();
            }

            async loadConversations() {
                try {
                    const user = auth.currentUser;
                    if (!user) {
                        console.log('❌ Utilisateur non connecté pour charger les conversations');
                        this.loadDemoConversations();
                        return;
                    }

                    // Vérifier les permissions
                    try {
                        const testQuery = query(collection(db, 'conversations'), limit(1));
                        await getDocs(testQuery);
                        console.log('✅ Permissions conversations vérifiées');
                    } catch (permError) {
                        console.log('❌ Erreur écoute conversations:', permError);
                        this.loadDemoConversations();
                        return;
                    }

                    const conversationsRef = collection(db, 'conversations');
                    const snapshot = await getDocs(conversationsRef);
                    
                    this.conversations = [];
                    snapshot.forEach(doc => {
                        this.conversations.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });

                    console.log(`💬 ${this.conversations.length} conversations chargées depuis Firebase`);
                } catch (error) {
                    console.error('❌ Erreur chargement conversations:', error);
                    this.loadDemoConversations();
                }
            }

            loadDemoConversations() {
                this.conversations = [
                    {
                        id: 'demo1',
                        name: 'Équipe Générale',
                        type: 'group',
                        participants: ['demo1', 'demo2', 'demo3'],
                        lastMessage: 'Bonne journée à tous!',
                        lastMessageTime: new Date()
                    },
                    {
                        id: 'demo2',
                        name: 'Projet SYNERGIA',
                        type: 'group',
                        participants: ['demo1', 'demo2'],
                        lastMessage: 'Les nouvelles fonctionnalités sont prêtes',
                        lastMessageTime: new Date(Date.now() - 3600000)
                    }
                ];
                console.log('💬 Conversations de démonstration chargées');
            }

            setupEventListeners() {
                const newConversationBtn = document.getElementById('new-conversation-btn');
                if (newConversationBtn) {
                    newConversationBtn.addEventListener('click', () => {
                        this.showNewConversationModal();
                    });
                }

                const videoCallBtn = document.getElementById('video-call-btn');
                if (videoCallBtn) {
                    videoCallBtn.addEventListener('click', () => {
                        console.log('INFO: Appel vidéo - Bientôt disponible');
                    });
                }

                const audioCallBtn = document.getElementById('audio-call-btn');
                if (audioCallBtn) {
                    audioCallBtn.addEventListener('click', () => {
                        console.log('INFO: Appel audio - Bientôt disponible');
                    });
                }

                const chatInfoBtn = document.getElementById('chat-info-btn');
                if (chatInfoBtn) {
                    chatInfoBtn.addEventListener('click', () => {
                        console.log('INFO: Informations conversation - Bientôt disponible');
                    });
                }
            }

            showNewConversationModal() {
                console.log('INFO: Nouvelle conversation - Bientôt disponible');
            }

            startPrivateChat(memberId) {
                console.log(`INFO: Chat privé avec membre ${memberId}`);
            }
        }

        // Analytics Manager
        class AnalyticsManager {
            constructor() {
                this.data = {};
                this.charts = {};
                this.init();
            }

            async init() {
                console.log('📊 Analytics Manager initialisé');
                await this.loadAnalyticsData();
                this.setupEventListeners();
            }

            async loadAnalyticsData() {
                console.log('📊 Chargement des données analytics...');
                // Simulation de chargement de données
                this.data = {
                    attendance: [85, 92, 78, 96, 89],
                    xp: [1250, 1300, 1450, 1600, 1750],
                    quests: [3, 5, 2, 7, 4],
                    performance: {
                        totalMembers: 3,
                        totalQuests: 21,
                        totalEvents: 5,
                        avgAttendance: 88
                    }
                };
                
                this.updateAnalytics();
                console.log('SUCCESS: Analytics actualisées');
            }

            updateAnalytics() {
                // Mettre à jour les statistiques globales
                document.getElementById('total-members').textContent = this.data.performance.totalMembers;
                document.getElementById('total-quests').textContent = this.data.performance.totalQuests;
                document.getElementById('total-events').textContent = this.data.performance.totalEvents;
                document.getElementById('avg-attendance').textContent = `${this.data.performance.avgAttendance}%`;
            }

            setupEventListeners() {
                const exportBtn = document.getElementById('export-data-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        this.exportData();
                    });
                }

                const periodSelect = document.getElementById('analytics-period');
                if (periodSelect) {
                    periodSelect.addEventListener('change', () => {
                        this.loadAnalyticsData();
                    });
                }
            }

            switchView(chartType, period) {
                console.log(`INFO: Vue ${chartType} - Graphique mis à jour`);
            }

            generateReport(reportType) {
                console.log(`INFO: Génération du rapport ${reportType}...`);
                
                if (reportType === 'attendance') {
                    console.log('INFO: Téléchargement du rapport attendance...');
                    console.log('INFO: Partage du rapport attendance...');
                    console.log('INFO: Génération du rapport en cours...');
                    setTimeout(() => {
                        console.log('SUCCESS: Rapport généré avec succès!');
                    }, 1000);
                }
            }

            exportData() {
                console.log('INFO: Export des données en cours...');
                setTimeout(() => {
                    console.log('SUCCESS: Données exportées vers CSV');
                }, 500);
            }

            showMemberAnalytics(memberId) {
                console.log(`INFO: Analytics pour membre ${memberId}`);
            }
        }

        // Badging Manager
        class BadgingManager {
            constructor() {
                this.clockedIn = false;
                this.currentSession = null;
                this.init();
            }

            init() {
                console.log('✅ Badging Manager initialized');
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Écouter les événements de pointage
                document.addEventListener('click', (e) => {
                    if (e.target.id === 'clock-in-btn') {
                        this.clockIn();
                    } else if (e.target.id === 'clock-out-btn') {
                        this.clockOut();
                    } else if (e.target.id === 'break-start-btn') {
                        this.startBreak();
                    } else if (e.target.id === 'break-end-btn') {
                        this.endBreak();
                    }
                });
            }

            clockIn() {
                this.clockedIn = true;
                this.currentSession = {
                    clockIn: new Date(),
                    breaks: []
                };
                
                console.log('SUCCESS: Pointage d\'arrivée enregistré!');
                
                // Notifier le Quest Manager
                if (window.questManager) {
                    window.questManager.handleCheckin(new Date());
                }
                
                // Émettre événement personnalisé
                document.dispatchEvent(new CustomEvent('synergia:checkin', {
                    detail: { time: new Date() }
                }));
            }

            clockOut() {
                if (this.currentSession) {
                    this.currentSession.clockOut = new Date();
                    console.log('SUCCESS: Pointage de départ enregistré!');
                    
                    // Vérifier si c'est une journée parfaite
                    this.checkPerfectDay();
                }
                
                this.clockedIn = false;
                this.currentSession = null;
            }

            startBreak() {
                if (this.currentSession) {
                    this.currentSession.breaks.push({
                        start: new Date()
                    });
                    console.log('INFO: Pause commencée');
                }
            }

            endBreak() {
                if (this.currentSession && this.currentSession.breaks.length > 0) {
                    const lastBreak = this.currentSession.breaks[this.currentSession.breaks.length - 1];
                    lastBreak.end = new Date();
                    console.log('INFO: Pause terminée');
                }
            }

            checkPerfectDay() {
                // Logique pour déterminer si c'est une journée parfaite
                const clockIn = this.currentSession.clockIn;
                const clockOut = this.currentSession.clockOut;
                
                if (clockIn.getHours() <= 9 && clockOut.getHours() >= 17) {
                    console.log('⭐ Journée parfaite détectée!');
                    
                    // Notifier le Quest Manager
                    if (window.questManager) {
                        window.questManager.handlePerfectDay();
                    }
                    
                    document.dispatchEvent(new CustomEvent('synergia:perfect_day'));
                }
            }
        }

        // Navigation
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.content-section');

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Retirer la classe active de tous les liens
                    navLinks.forEach(l => l.classList.remove('active'));
                    // Ajouter la classe active au lien cliqué
                    link.classList.add('active');
                    
                    // Cacher toutes les sections
                    sections.forEach(section => section.classList.remove('active'));
                    
                    // Afficher la section correspondante
                    const targetId = link.getAttribute('href').substring(1);
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.classList.add('active');
                    }
                });
            });
        }

        // Quests UI
        function setupQuestsUI() {
            // Charger les quêtes quotidiennes
            function loadQuests() {
                if (questManager.questsLoaded) {
                    console.log('⏳ Chargement des quêtes déjà en cours...');
                    return;
                }

                console.log('🎯 Chargement des quêtes...');
                
                const dailyQuests = questManager.getDailyQuests();
                const weeklyQuests = questManager.getWeeklyQuests();
                const userQuests = questManager.getUserQuests();
                
                console.log(`Quêtes quotidiennes: ${dailyQuests.length}`);
                console.log(`Quêtes hebdomadaires: ${weeklyQuests.length}`);
                console.log(`Quêtes utilisateur: ${userQuests.length}`);
                
                const questsList = document.getElementById('quests-list');
                if (questsList) {
                    questsList.innerHTML = '';
                    
                    // Afficher toutes les quêtes disponibles
                    const allQuests = questManager.getAvailableQuests();
                    allQuests.forEach(quest => {
                        const questCard = createQuestCard(quest);
                        questsList.appendChild(questCard);
                    });
                    
                    console.log(`✅ ${allQuests.length} missions affichées`);
                }
                
                // Mettre à jour l'affichage du niveau utilisateur
                updateUserLevelDisplay();
            }

            function createQuestCard(quest) {
                const card = document.createElement('div');
                card.className = 'quest-card';
                card.innerHTML = `
                    <div class="quest-icon">${quest.icon}</div>
                    <div class="quest-info">
                        <h3>${quest.title}</h3>
                        <p>${quest.description}</p>
                        <div class="quest-reward">
                            <span class="xp-reward">${quest.xp} XP</span>
                            <span class="quest-type">${quest.type}</span>
                        </div>
                    </div>
                    <div class="quest-actions">
                        <button onclick="acceptQuest('${quest.id}')" class="btn btn-primary">
                            Accepter
                        </button>
                    </div>
                `;
                return card;
            }

            async function acceptQuest(questId) {
                console.log(`✅ Acceptation de la quête: ${questId}`);
                
                const userQuest = await questManager.acceptQuest(questId);
                if (userQuest) {
                    const quest = questManager.getQuestById(questId);
                    console.log(`🎯 Nouvelle quête assignée: ${quest.title}`);
                    console.log(`INFO: Nouvelle mission: ${quest.title}`);
                    console.log('SUCCESS: Mission acceptée!');
                    
                    // Recharger la liste des quêtes
                    loadQuests();
                }
            }

            function updateUserLevelDisplay() {
                console.log('INFO: Niveau 1 - 0 XP - 0/5 missions');
            }

            // Exposer les fonctions globalement
            window.loadQuests = loadQuests;
            window.acceptQuest = acceptQuest;

            // Charger les quêtes au démarrage
            setTimeout(loadQuests, 1000);
        }

        // Initialisation principale
        async function init() {
            try {
                // Attendre Firebase
                await waitForFirebase();
                
                // Configuration de l'authentification
                onAuthStateChanged(auth, handleAuthStateChange);
                
                // Configuration de la navigation
                setupNavigation();
                
                // Configuration des quêtes
                setupQuestsUI();
                
                // Logout
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        auth.signOut();
                    });
                }
                
                console.log('✅ SYNERGIA v3.0 initialized successfully!');
                
            } catch (error) {
                console.error('❌ Erreur lors de l\'initialisation:', error);
            }
        }

        // Fonctions utilitaires globales
        window.log = (message, type = 'INFO') => {
            console.log(`${type}: ${message}`);
        };

        window.success = (message) => window.log(message, 'SUCCESS');
        window.error = (message) => window.log(message, 'ERROR');
        window.warning = (message) => window.log(message, 'WARNING');

        // Démarrage de l'application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
